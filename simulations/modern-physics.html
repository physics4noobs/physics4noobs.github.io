<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photoelectric Effect | AXOMIYA ENGINEER</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî¨</text></svg>">
  <script src="../js/theme.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script defer src="../js/firebase-config.js"></script>
  <script defer src="../js/auth.js"></script>
  <script defer src="../js/sim-tracker.js"></script>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash">
    <div class="splash-pendulum">
      <div class="sp-pivot"></div>
      <div class="sp-arm">
        <div class="sp-rod"></div>
        <div class="sp-bob"></div>
      </div>
    </div>
    <div class="splash-brand">AXOMIYA ENGINEER</div>
  </div>
  <script>
    (function(){if(sessionStorage.getItem('ae-splash')){document.getElementById('splash').style.display='none';}else{sessionStorage.setItem('ae-splash','1');setTimeout(function(){document.getElementById('splash').classList.add('fade-out');setTimeout(function(){document.getElementById('splash').style.display='none';},400);},1000);}})();
  </script>

  <div class="bg-grid"></div>
  <nav class="navbar scrolled"><div class="nav-container"><a href="../index.html" class="nav-logo"><div class="logo-icon"><div class="logo-pendulum"><div class="pendulum-pivot"></div><div class="pendulum-arm"><div class="pendulum-rod"></div><div class="pendulum-bob"></div></div></div></div><div class="logo-text"><span class="brand-name">Axomiya Engineer</span><span class="brand-tag">IIT Guwahati &bull; Physics</span></div></a><div class="nav-links"><div class="nav-item"><a href="../index.html" class="nav-link">Home</a></div><div class="nav-item"><a href="../simulations.html" class="nav-link active">Simulations</a></div><div class="nav-item"><a href="../chapters.html" class="nav-link">Chapters</a></div><button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button><button class="auth-btn" id="auth-login-btn"><svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Sign in</button><div class="user-menu nav-item" id="auth-user-menu" style="display:none;"><img class="user-avatar" id="auth-user-avatar" src="" alt="User"><span class="user-name" id="auth-user-name"></span><div class="dropdown"><a href="../progress.html"><div class="dd-icon">&#128200;</div> My Progress</a><div class="dropdown-divider"></div><a href="#" id="auth-logout-btn"><div class="dd-icon">&#128682;</div> Sign Out</a></div></div><a href="../index.html#contact" class="nav-cta">Contact Me</a></div><button class="nav-toggle" aria-label="Menu"><span></span><span></span><span></span></button></div></nav>

  <style>
    body { background: #0a0a0a !important; }
    .bg-grid, #particles-canvas { display: none !important; }

    .sim-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 24px 40px;
    }

    .sim-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .sim-header h1 {
      font-family: 'Inter', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      color: #e0e0e0;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .sim-btn {
      padding: 8px 20px;
      font-size: 0.82rem;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      color: #e0e0e0;
      background: transparent;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
      letter-spacing: 0.5px;
    }

    .sim-btn:hover {
      background: #e0e0e0;
      color: #0a0a0a;
      border-color: #e0e0e0;
    }

    .sim-main-row {
      display: flex;
      gap: 0;
    }

    .canvas-wrap {
      flex: 1;
      border: 1px solid #222;
      border-radius: 6px 0 0 0;
      overflow: hidden;
      background: #111;
    }

    .canvas-wrap canvas {
      display: block;
      width: 100%;
    }

    .side-graph {
      width: 320px;
      min-width: 260px;
      background: #161616;
      border: 1px solid #222;
      border-left: none;
      border-radius: 0 6px 0 0;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .side-graph h3 {
      font-family: 'Inter', sans-serif;
      font-size: 0.82rem;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
    }

    .side-graph canvas {
      width: 100%;
      flex: 1;
      border-radius: 4px;
    }

    /* Controls */
    .controls-bar {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 16px 20px;
      background: #161616;
      border: 1px solid #222;
      border-top: none;
      border-radius: 0 0 6px 6px;
      flex-wrap: wrap;
      margin-top: 0;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      color: #888;
      white-space: nowrap;
    }

    .control-group input[type="range"] {
      width: 120px;
      -webkit-appearance: none;
      background: #333;
      height: 3px;
      border-radius: 2px;
      outline: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #e0e0e0;
      border-radius: 50%;
      cursor: pointer;
    }

    .control-group .val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      color: #e0e0e0;
      min-width: 52px;
      text-align: right;
    }

    .control-group select {
      background: #222;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 6px 10px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      cursor: pointer;
      outline: none;
    }

    .control-group select:hover {
      border-color: #555;
    }

    .spectrum-bar {
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right,
        #cc0000 0%,
        #ff4400 20%,
        #ffaa00 33%,
        #ffff00 42%,
        #aaff00 48%,
        #00ff44 58%,
        #00ccff 67%,
        #0044ff 75%,
        #4400ff 85%,
        #8000ff 100%
      );
      margin-top: 2px;
      position: relative;
    }

    .spectrum-marker {
      position: absolute;
      top: -3px;
      width: 4px;
      height: 12px;
      background: #fff;
      border-radius: 2px;
      transform: translateX(-50%);
      box-shadow: 0 0 4px rgba(255,255,255,0.5);
    }

    /* Data panel */
    .data-panel {
      background: #161616;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 20px;
      margin-top: 16px;
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0 32px;
    }

    .data-panel h3 {
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 16px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1e1e1e;
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      color: #888;
    }

    .data-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      color: #e0e0e0;
      font-weight: 500;
    }

    .data-value.emission {
      color: #4AFF8B;
    }

    .data-value.no-emission {
      color: #FF4A6E;
    }


    /* Q&A */
    .qa-section {
      margin-top: 32px;
    }

    .qa-section h2 {
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 16px;
    }

    .qa-item {
      background: #161616;
      border: 1px solid #222;
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .qa-q {
      padding: 14px 20px;
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      color: #e0e0e0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }

    .qa-q:hover {
      background: #1a1a1a;
    }

    .qa-q::after {
      content: '+';
      font-size: 1.2rem;
      color: #555;
      transition: transform 0.2s;
    }

    .qa-item.open .qa-q::after {
      content: '-';
    }

    .qa-a {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .qa-item.open .qa-a {
      max-height: 300px;
    }

    .qa-a-inner {
      padding: 0 20px 16px;
      font-family: 'Inter', sans-serif;
      font-size: 0.84rem;
      color: #aaa;
      line-height: 1.6;
    }

    @media (max-width: 900px) {
      .sim-main-row { flex-direction: column; }
      .side-graph { width: 100%; border-left: 1px solid #222; border-top: none; border-radius: 0; }
      .canvas-wrap { border-radius: 6px 6px 0 0; }
    }
    @media (max-width: 768px) {
      .sim-wrapper { padding: 70px 12px 24px; }
      .controls-bar { gap: 12px; padding: 12px; }
      .control-group input[type="range"] { width: 80px; }
      .spectrum-bar { width: 80px; }
    }
  </style>

  <div class="sim-wrapper">
    <div class="sim-header">
      <h1>Photoelectric Effect</h1>
      <button class="sim-btn" id="resetBtn">Reset</button>
    </div>

    <div class="sim-main-row">
      <div class="canvas-wrap">
        <canvas id="simCanvas"></canvas>
      </div>
      <div class="side-graph">
        <h3>V &ndash; I Characteristic</h3>
        <canvas id="graphCanvas"></canvas>
      </div>
    </div>

    <div class="controls-bar">
      <div class="control-group">
        <label>f</label>
        <div>
          <input type="range" id="freqSlider" min="40" max="150" value="86" step="1">
          <div class="spectrum-bar"><div class="spectrum-marker" id="specMarker"></div></div>
        </div>
        <span class="val" id="freqVal">8.6 &times;10<sup>14</sup> Hz</span>
      </div>
      <div class="control-group">
        <label>Intensity</label>
        <input type="range" id="intensitySlider" min="1" max="100" value="50" step="1">
        <span class="val" id="intensityVal">50%</span>
      </div>
      <div class="control-group">
        <label>Voltage</label>
        <input type="range" id="voltageSlider" min="-50" max="50" value="0" step="1">
        <span class="val" id="voltageVal">0.0 V</span>
      </div>
      <div class="control-group">
        <label>Metal</label>
        <select id="metalSelect">
          <option value="0">Cesium (2.14 eV)</option>
          <option value="1" selected>Sodium (2.28 eV)</option>
          <option value="2">Potassium (2.30 eV)</option>
          <option value="3">Calcium (2.87 eV)</option>
          <option value="4">Aluminum (4.08 eV)</option>
          <option value="5">Zinc (4.33 eV)</option>
          <option value="6">Iron (4.50 eV)</option>
          <option value="7">Copper (4.65 eV)</option>
          <option value="8">Silver (4.73 eV)</option>
          <option value="9">Platinum (5.65 eV)</option>
        </select>
      </div>
    </div>

    <div class="data-panel">
      <h3>Data</h3>
      <div class="data-grid">
        <div class="data-row"><span class="data-label">Photon Energy (E)</span><span class="data-value" id="dEnergy">3.56 eV</span></div>
        <div class="data-row"><span class="data-label">Work Function (&phi;)</span><span class="data-value" id="dPhi">2.28 eV</span></div>
        <div class="data-row"><span class="data-label">Threshold f</span><span class="data-value" id="dThresh">5.51 &times;10<sup>14</sup> Hz</span></div>
        <div class="data-row"><span class="data-label">Max KE</span><span class="data-value" id="dKE">1.28 eV</span></div>
        <div class="data-row"><span class="data-label">Stopping Potential</span><span class="data-value" id="dVstop">1.28 V</span></div>
        <div class="data-row"><span class="data-label">Saturation Current</span><span class="data-value" id="dIsat">5.00 &micro;A</span></div>
        <div class="data-row"><span class="data-label">Current</span><span class="data-value" id="dCurrent">5.00 &micro;A</span></div>
        <div class="data-row"><span class="data-label">Status</span><span class="data-value emission" id="dStatus">Emission</span></div>
      </div>
    </div>

    <div class="qa-section">
      <h2>Questions &amp; Answers</h2>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is the photoelectric effect?</div>
        <div class="qa-a"><div class="qa-a-inner">The emission of electrons from a metal surface when light of sufficient frequency shines on it. Einstein explained this in 1905: light consists of photons with energy E = hf. If hf &gt; &phi; (work function), electrons are emitted with maximum kinetic energy KE<sub>max</sub> = hf &minus; &phi;. This discovery earned Einstein the Nobel Prize in Physics in 1921.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">Why doesn't increasing intensity increase electron energy?</div>
        <div class="qa-a"><div class="qa-a-inner">Intensity means more photons per second, not more energetic photons. Each photon's energy depends only on frequency: E = hf. More photons &rarr; more electrons &rarr; more current, but each electron's maximum KE stays the same. Try it: move the intensity slider and watch the current change while Max KE remains constant.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is stopping potential and how is it measured?</div>
        <div class="qa-a"><div class="qa-a-inner">The minimum reverse voltage needed to stop the most energetic photoelectrons. Apply negative voltage to the anode until the current drops to zero: V<sub>0</sub> = KE<sub>max</sub>/e = (hf &minus; &phi;)/e. It depends on frequency but NOT on intensity. The V&ndash;I graph on the right clearly shows this &mdash; the stopping potential (red dashed line) stays fixed when you change intensity.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">Why is there a threshold frequency?</div>
        <div class="qa-a"><div class="qa-a-inner">A photon must deliver enough energy in a single quantum to overcome the work function &phi;. Below the threshold frequency (hf &lt; &phi;), no single photon has enough energy to liberate an electron &mdash; regardless of how many photons (intensity) or how long you shine the light. The threshold wavelength is &lambda;<sub>0</sub> = hc/&phi; = 1239.84/&phi; nm.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">How did the photoelectric effect prove light is quantized?</div>
        <div class="qa-a"><div class="qa-a-inner">Classical wave theory predicted three things, all wrong: (1) any frequency should eject electrons if intensity is high enough, (2) there should be a time delay before emission starts, (3) kinetic energy should depend on intensity. Einstein's photon model correctly explained: instantaneous emission above threshold, KE depending only on frequency, and current depending on intensity. This was key evidence for quantum mechanics.</div></div>
      </div>
    </div>
  </div>

  <script>
    // === METALS ===
    const metals = [
      { name: 'Cesium',    W: 2.14 },
      { name: 'Sodium',    W: 2.28 },
      { name: 'Potassium', W: 2.30 },
      { name: 'Calcium',   W: 2.87 },
      { name: 'Aluminum',  W: 4.08 },
      { name: 'Zinc',      W: 4.33 },
      { name: 'Iron',      W: 4.50 },
      { name: 'Copper',    W: 4.65 },
      { name: 'Silver',    W: 4.73 },
      { name: 'Platinum',  W: 5.65 }
    ];

    // === STATE ===
    let freq = 8.6;       // √ó10¬π‚Å¥ Hz (default: UV, above sodium threshold)
    let intensity = 50;
    let voltage = 0;
    let metalIdx = 1;
    let photons = [];
    let electrons = [];
    let frameCount = 0;
    let arrivedCount = 0;
    let smoothCurrent = 0;

    // === DOM ===
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const graphCanvas = document.getElementById('graphCanvas');
    const gctx = graphCanvas.getContext('2d');

    const freqSlider = document.getElementById('freqSlider');
    const intensitySlider = document.getElementById('intensitySlider');
    const voltageSlider = document.getElementById('voltageSlider');
    const metalSelect = document.getElementById('metalSelect');
    const specMarker = document.getElementById('specMarker');

    // === PHYSICS ===
    // h = 4.136√ó10‚Åª¬π‚Åµ eV¬∑s, freq in 10¬π‚Å¥ Hz ‚Üí E = 0.4136 √ó freq
    function photonEnergy() { return 0.4136 * freq; }
    function wavelength() { return 3000 / freq; } // nm, for color mapping
    function workFunction() { return metals[metalIdx].W; }
    function maxKE() { return Math.max(0, photonEnergy() - workFunction()); }
    function stoppingV() { return maxKE(); }
    function thresholdFreq() { return workFunction() / 0.4136; } // √ó10¬π‚Å¥ Hz
    function satCurrent() {
      if (photonEnergy() < workFunction()) return 0;
      return (intensity / 100) * 10;
    }
    function currentAt(V) {
      if (photonEnergy() < workFunction()) return 0;
      var Isat = satCurrent();
      var Vs = stoppingV();
      if (Vs <= 0.001) return 0;
      if (V <= -Vs) return 0;
      // Retarding region: V < 0
      if (V <= 0) {
        var ratio = (V + Vs) / Vs;
        return Isat * 0.75 * ratio * ratio;
      }
      // Accelerating region: V > 0, gradually reach saturation ~+2V
      return Isat * (1 - 0.25 * Math.exp(-V * 2));
    }

    // === WAVELENGTH TO COLOR ===
    function wlToRGB(wl) {
      var r = 0, g = 0, b = 0;
      if (wl < 380) {
        // UV ‚Äî purple
        r = 0.5; g = 0; b = 1;
      } else if (wl < 440) {
        r = -(wl - 440) / (440 - 380);
        g = 0; b = 1;
      } else if (wl < 490) {
        r = 0; g = (wl - 440) / (490 - 440); b = 1;
      } else if (wl < 510) {
        r = 0; g = 1; b = -(wl - 510) / (510 - 490);
      } else if (wl < 580) {
        r = (wl - 510) / (580 - 510); g = 1; b = 0;
      } else if (wl < 645) {
        r = 1; g = -(wl - 645) / (645 - 580); b = 0;
      } else {
        r = 1; g = 0; b = 0;
      }
      // Intensity correction at edges
      var factor;
      if (wl < 380) factor = 0.6;
      else if (wl < 420) factor = 0.3 + 0.7 * (wl - 380) / (420 - 380);
      else if (wl <= 700) factor = 1;
      else factor = 0.3;
      return {
        r: Math.round(r * factor * 255),
        g: Math.round(g * factor * 255),
        b: Math.round(b * factor * 255)
      };
    }

    // === CANVAS SETUP ===
    var dpr = window.devicePixelRatio || 1;

    function resizeCanvas() {
      var wrap = canvas.parentElement;
      var w = wrap.clientWidth;
      var h = Math.max(350, Math.min(w * 0.55, window.innerHeight * 0.55));
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Graph canvas ‚Äî sits beside the main canvas
      var gWrap = graphCanvas.parentElement;
      var gw = gWrap.clientWidth - 32;
      var gh = h - 42; // match main canvas height minus header
      graphCanvas.width = gw * dpr;
      graphCanvas.height = gh * dpr;
      graphCanvas.style.height = gh + 'px';
      gctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener('resize', resizeCanvas);

    // === DRAWING ===
    function drawSim() {
      var W = canvas.width / dpr;
      var H = canvas.height / dpr;
      var wl = wavelength();
      var color = wlToRGB(wl);
      var emission = photonEnergy() > workFunction();

      // Background
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, W, H);

      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.03)';
      ctx.lineWidth = 1;
      for (var x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
      for (var y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

      // Layout proportions
      var tubeL = W * 0.28;
      var tubeR = W * 0.78;
      var tubeT = H * 0.1;
      var tubeB = H * 0.65;
      var cathodeX = W * 0.36;
      var anodeX = W * 0.7;
      var plateTop = tubeT + 20;
      var plateBot = tubeB - 20;

      // === VACUUM TUBE ===
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.beginPath();
      var tubePad = 15;
      ctx.moveTo(tubeL + tubePad, tubeT);
      ctx.lineTo(tubeR - tubePad, tubeT);
      ctx.quadraticCurveTo(tubeR, tubeT, tubeR, tubeT + tubePad);
      ctx.lineTo(tubeR, tubeB - tubePad);
      ctx.quadraticCurveTo(tubeR, tubeB, tubeR - tubePad, tubeB);
      ctx.lineTo(tubeL + tubePad, tubeB);
      ctx.quadraticCurveTo(tubeL, tubeB, tubeL, tubeB - tubePad);
      ctx.lineTo(tubeL, tubeT + tubePad);
      ctx.quadraticCurveTo(tubeL, tubeT, tubeL + tubePad, tubeT);
      ctx.stroke();

      // Vacuum label
      ctx.fillStyle = '#2a2a2a';
      ctx.font = '10px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('VACUUM', (tubeL + tubeR) / 2, tubeT + 14);

      // Window on tube (where light enters at angle)
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(tubeL + tubePad, tubeT);
      ctx.lineTo((tubeL + tubeR) / 2 - 10, tubeT);
      ctx.stroke();

      // === CATHODE ===
      var cathGrad = ctx.createLinearGradient(cathodeX - 8, 0, cathodeX + 8, 0);
      cathGrad.addColorStop(0, '#4a4a5a');
      cathGrad.addColorStop(0.5, '#6a6a7a');
      cathGrad.addColorStop(1, '#4a4a5a');
      ctx.fillStyle = cathGrad;
      ctx.fillRect(cathodeX - 6, plateTop, 12, plateBot - plateTop);
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 1;
      ctx.strokeRect(cathodeX - 6, plateTop, 12, plateBot - plateTop);

      // Glow on cathode if emission
      if (emission) {
        ctx.fillStyle = 'rgba(74, 255, 139, 0.04)';
        ctx.fillRect(cathodeX + 6, plateTop, 30, plateBot - plateTop);
      }

      // === ANODE ===
      var anGrad = ctx.createLinearGradient(anodeX - 6, 0, anodeX + 6, 0);
      anGrad.addColorStop(0, '#5a5a6a');
      anGrad.addColorStop(0.5, '#7a7a8a');
      anGrad.addColorStop(1, '#5a5a6a');
      ctx.fillStyle = anGrad;
      ctx.fillRect(anodeX - 5, plateTop, 10, plateBot - plateTop);
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      ctx.strokeRect(anodeX - 5, plateTop, 10, plateBot - plateTop);

      // Labels
      ctx.fillStyle = '#555';
      ctx.font = '11px JetBrains Mono, monospace';
      ctx.textAlign = 'center';
      ctx.fillText('Cathode', cathodeX, tubeB + 16);
      ctx.fillText('Anode', anodeX, tubeB + 16);

      // === LIGHT SOURCE (top center, shining diagonally onto cathode) ===
      var lsX = (tubeL + tubeR) / 2;
      var lsY = H * 0.04;
      var lsR = 18;
      // Target point on cathode surface (where beam hits)
      var targetX = cathodeX - 6;
      var targetY = (plateTop + plateBot) / 2;

      // Outer glow
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR + 8, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.08)';
      ctx.fill();

      // Lamp body
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR, 0, Math.PI * 2);
      ctx.fillStyle = '#1a1a2a';
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1.5;
      ctx.fill();
      ctx.stroke();

      // Inner glow
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR - 5, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.6)';
      ctx.shadowColor = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
      ctx.shadowBlur = 15;
      ctx.fill();
      ctx.shadowBlur = 0;

      // Light beam cone ‚Äî diagonal from source down to cathode surface
      var beamSpread = 12;
      ctx.beginPath();
      ctx.moveTo(lsX - 4, lsY + lsR);
      ctx.lineTo(targetX - beamSpread, plateTop);
      ctx.lineTo(targetX + beamSpread, plateBot);
      ctx.lineTo(lsX + 4, lsY + lsR);
      ctx.closePath();
      ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.04)';
      ctx.fill();

      // Label
      ctx.fillStyle = '#888';
      ctx.font = '10px JetBrains Mono, monospace';
      ctx.textAlign = 'left';
      ctx.fillText(freq.toFixed(1) + '\u00D710\u00B9\u2074 Hz', lsX + lsR + 6, lsY + 4);
      if (wl < 380) {
        ctx.fillStyle = '#666';
        ctx.fillText('(UV)', lsX + lsR + 6, lsY + 16);
      }

      // === CIRCUIT (below tube) ===
      var circY = tubeB + 40;
      var circBot = H - 15;
      var midY = (circY + circBot) / 2;

      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1.5;

      // Wire from cathode down
      ctx.beginPath();
      ctx.moveTo(cathodeX, plateBot);
      ctx.lineTo(cathodeX, circBot);
      ctx.stroke();

      // Wire from anode down
      ctx.beginPath();
      ctx.moveTo(anodeX, plateBot);
      ctx.lineTo(anodeX, circBot);
      ctx.stroke();

      // Bottom wire left
      ctx.beginPath();
      ctx.moveTo(cathodeX, circBot);
      ctx.lineTo((cathodeX + anodeX) / 2 - 30, circBot);
      ctx.stroke();

      // Bottom wire right
      ctx.beginPath();
      ctx.moveTo((cathodeX + anodeX) / 2 + 30, circBot);
      ctx.lineTo(anodeX, circBot);
      ctx.stroke();

      // Battery symbol
      var batX = (cathodeX + anodeX) / 2;
      var batY = circBot;
      // Long line (positive)
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(batX - 8, batY - 8);
      ctx.lineTo(batX - 8, batY + 8);
      ctx.stroke();
      // Short line (negative)
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(batX + 8, batY - 5);
      ctx.lineTo(batX + 8, batY + 5);
      ctx.stroke();

      // Battery label
      ctx.fillStyle = '#888';
      ctx.font = '10px JetBrains Mono, monospace';
      ctx.textAlign = 'center';
      var vStr = voltage >= 0 ? '+' + voltage.toFixed(1) : voltage.toFixed(1);
      ctx.fillText(vStr + ' V', batX, batY - 14);

      // Ammeter on right wire
      var amX = anodeX + 30;
      var amY = (plateBot + circBot) / 2;
      // Wire to ammeter
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(anodeX, amY - 12);
      ctx.lineTo(anodeX, amY + 12);
      ctx.stroke();

      // Ammeter circle (on the wire)
      ctx.beginPath();
      ctx.arc(anodeX, amY, 14, 0, Math.PI * 2);
      ctx.fillStyle = '#1a1a1a';
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 1.5;
      ctx.fill();
      ctx.stroke();

      // A label
      ctx.fillStyle = '#e0e0e0';
      ctx.font = 'bold 11px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('A', anodeX, amY);
      ctx.textBaseline = 'alphabetic';

      // Current value near ammeter
      var curVal = currentAt(voltage);
      ctx.fillStyle = emission ? '#4AFF8B' : '#666';
      ctx.font = '10px JetBrains Mono, monospace';
      ctx.fillText(curVal.toFixed(2) + ' \u00B5A', anodeX + 30, amY + 4);

      // === PHOTON PARTICLES (diagonal from top-center to cathode) ===
      frameCount++;
      var spawnRate = Math.max(1, Math.floor(8 - (intensity / 100) * 7));
      // Direction vector from light source to cathode surface
      var dx = targetX - lsX;
      var dy = targetY - lsY;
      var dist = Math.sqrt(dx * dx + dy * dy);
      var dirX = dx / dist;
      var dirY = dy / dist;

      if (frameCount % spawnRate === 0) {
        // Spawn near light source with slight spread
        var spread = (Math.random() - 0.5) * 8;
        photons.push({
          x: lsX + spread * dirY,
          y: lsY + lsR + Math.abs(spread * dirX),
          speed: 2.5 + Math.random() * 1.5,
          wave: Math.random() * Math.PI * 2,
          hitY: plateTop + Math.random() * (plateBot - plateTop)
        });
      }

      // Cap photon count
      if (photons.length > 80) photons.splice(0, photons.length - 80);

      photons = photons.filter(function(p) {
        p.x += dirX * p.speed;
        p.y += dirY * p.speed;
        p.wave += 0.15;

        // Hit the cathode surface (reached cathode x position)
        if (p.x <= cathodeX + 6 && p.y >= plateTop - 5) {
          if (emission) {
            var ke = Math.random() * maxKE();
            var speed = 0.8 + (ke / Math.max(0.01, maxKE())) * 2.5;
            var angle = (Math.random() - 0.5) * Math.PI * 0.8;
            electrons.push({
              x: cathodeX + 8,
              y: Math.max(plateTop, Math.min(plateBot, p.y)),
              vx: speed * Math.cos(angle),
              vy: speed * Math.sin(angle),
              ke: ke,
              life: 300,
              turned: false
            });
          }
          return false;
        }

        // Out of bounds
        if (p.y > tubeB + 10 || p.x < tubeL - 10) return false;

        // Draw photon
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.9)';
        ctx.shadowColor = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
        ctx.shadowBlur = 8;
        ctx.fill();
        ctx.shadowBlur = 0;

        // Wave trail (behind the photon, opposite to direction)
        ctx.strokeStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (var i = 0; i < 15; i++) {
          var tx = p.x - dirX * i * 2 + Math.sin(p.wave - i * 0.5) * dirY * 2.5;
          var ty = p.y - dirY * i * 2 - Math.sin(p.wave - i * 0.5) * dirX * 2.5;
          if (i === 0) ctx.moveTo(tx, ty);
          else ctx.lineTo(tx, ty);
        }
        ctx.stroke();

        return true;
      });

      // === ELECTRON PARTICLES ===
      if (electrons.length > 100) electrons.splice(0, electrons.length - 100);

      arrivedCount = 0;
      electrons = electrons.filter(function(e) {
        e.life--;
        if (e.life <= 0) return false;

        // Voltage effect: accelerate toward anode (positive V) or away (negative V)
        var accel = 0;
        if (voltage >= 0) {
          accel = 0.01 + voltage * 0.015;
        } else {
          accel = voltage * 0.015;
        }
        e.vx += accel;

        // Dampen vertical drift with positive voltage (field straightens path)
        if (voltage > 0) {
          e.vy *= 0.98;
        }

        // If electron stopped or turned back
        if (e.vx < 0) {
          e.turned = true;
        }

        e.x += e.vx;
        e.y += e.vy;

        // Reached anode
        if (e.x >= anodeX - 5 && !e.turned) {
          arrivedCount++;
          return false;
        }

        // Turned back past cathode
        if (e.x < cathodeX - 10) return false;

        // Drifted out of tube vertically
        if (e.y < plateTop || e.y > plateBot) return false;

        // Out of bounds
        if (e.x > anodeX + 20) return false;

        // Draw electron
        var alpha = Math.min(1, e.life / 60);
        var eColor = e.turned ? '255, 74, 110' : '74, 255, 139';
        ctx.beginPath();
        ctx.arc(e.x, e.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + eColor + ',' + alpha + ')';
        ctx.shadowColor = 'rgba(' + eColor + ',0.6)';
        ctx.shadowBlur = 6;
        ctx.fill();
        ctx.shadowBlur = 0;

        return true;
      });

      // === NO EMISSION INDICATOR ===
      if (!emission) {
        ctx.fillStyle = 'rgba(255, 74, 110, 0.06)';
        ctx.fillRect(cathodeX - 8, plateTop, 16, plateBot - plateTop);

        ctx.fillStyle = '#FF4A6E';
        ctx.font = 'bold 13px Inter, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No Emission', (cathodeX + anodeX) / 2, (tubeT + tubeB) / 2 - 8);
        ctx.font = '11px JetBrains Mono, monospace';
        ctx.fillStyle = '#aa3355';
        ctx.fillText('E < \u03C6  (' + photonEnergy().toFixed(2) + ' < ' + workFunction().toFixed(2) + ' eV)', (cathodeX + anodeX) / 2, (tubeT + tubeB) / 2 + 12);
      }

      // === FORMULA at top-right ===
      var fX = W * 0.82;
      var fY = H * 0.08;
      ctx.fillStyle = 'rgba(17,17,17,0.9)';
      ctx.fillRect(fX - 10, fY - 4, W * 0.17, 60);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 1;
      ctx.strokeRect(fX - 10, fY - 4, W * 0.17, 60);
      ctx.fillStyle = '#666';
      ctx.font = '11px JetBrains Mono, monospace';
      ctx.textAlign = 'left';
      ctx.fillText('E = hf', fX, fY + 14);
      ctx.fillText('KE = hf \u2212 \u03C6', fX, fY + 30);
      ctx.fillText('V\u2080 = KE/e', fX, fY + 46);

      requestAnimationFrame(drawSim);
    }

    // === V-I GRAPH ===
    function drawGraph() {
      var w = graphCanvas.width / dpr;
      var h = graphCanvas.height / dpr;

      gctx.fillStyle = '#161616';
      gctx.fillRect(0, 0, w, h);

      var padL = 45, padR = 15, padT = 15, padB = 35;
      var plotW = w - padL - padR;
      var plotH = h - padT - padB;
      var Isat = satCurrent();
      var Vs = stoppingV();
      var emitting = photonEnergy() > workFunction();

      // Axes
      gctx.strokeStyle = '#444';
      gctx.lineWidth = 1;
      gctx.beginPath();
      gctx.moveTo(padL, padT);
      gctx.lineTo(padL, padT + plotH);
      gctx.lineTo(padL + plotW, padT + plotH);
      gctx.stroke();

      // Grid lines
      gctx.strokeStyle = 'rgba(255,255,255,0.04)';
      for (var i = 1; i <= 4; i++) {
        var gy = padT + plotH * (1 - i / 4);
        gctx.beginPath();
        gctx.moveTo(padL, gy);
        gctx.lineTo(padL + plotW, gy);
        gctx.stroke();
      }
      for (var i = 1; i <= 9; i++) {
        var gx = padL + plotW * i / 10;
        gctx.beginPath();
        gctx.moveTo(gx, padT);
        gctx.lineTo(gx, padT + plotH);
        gctx.stroke();
      }

      // Axis labels
      gctx.fillStyle = '#666';
      gctx.font = '10px JetBrains Mono, monospace';
      gctx.textAlign = 'center';
      gctx.fillText('V (volts)', padL + plotW / 2, h - 5);
      // Y label
      gctx.save();
      gctx.translate(12, padT + plotH / 2);
      gctx.rotate(-Math.PI / 2);
      gctx.fillText('I (\u00B5A)', 0, 0);
      gctx.restore();

      // Tick labels on X
      gctx.textAlign = 'center';
      gctx.fillStyle = '#555';
      gctx.font = '9px JetBrains Mono, monospace';
      for (var v = -5; v <= 5; v += 2.5) {
        var tx = padL + ((v + 5) / 10) * plotW;
        gctx.fillText(v.toFixed(1), tx, padT + plotH + 14);
        // Tick mark
        gctx.beginPath();
        gctx.moveTo(tx, padT + plotH);
        gctx.lineTo(tx, padT + plotH + 4);
        gctx.strokeStyle = '#444';
        gctx.stroke();
      }

      // Tick labels on Y
      gctx.textAlign = 'right';
      var yMax = 12; // Fixed scale (max Isat = 10 ŒºA at 100% intensity)
      for (var i = 0; i <= 4; i++) {
        var yVal = (i / 4) * yMax;
        var ty = padT + plotH * (1 - i / 4);
        gctx.fillText(yVal.toFixed(1), padL - 6, ty + 3);
      }

      // V=0 axis (prominent vertical line)
      var zeroX = padL + (5 / 10) * plotW;
      gctx.strokeStyle = 'rgba(255,255,255,0.35)';
      gctx.lineWidth = 1.5;
      gctx.beginPath();
      gctx.moveTo(zeroX, padT);
      gctx.lineTo(zeroX, padT + plotH);
      gctx.stroke();
      // V=0 label
      gctx.fillStyle = 'rgba(255,255,255,0.4)';
      gctx.font = '9px JetBrains Mono, monospace';
      gctx.textAlign = 'center';
      gctx.fillText('0', zeroX, padT + plotH + 14);

      // I=0 axis (prominent horizontal line at bottom of plot)
      gctx.strokeStyle = 'rgba(255,255,255,0.35)';
      gctx.lineWidth = 1.5;
      gctx.beginPath();
      gctx.moveTo(padL, padT + plotH);
      gctx.lineTo(padL + plotW, padT + plotH);
      gctx.stroke();

      if (emitting && Isat > 0) {
        // Stopping potential marker
        if (Vs > 0 && Vs <= 5) {
          var vsX = padL + ((-Vs + 5) / 10) * plotW;
          gctx.strokeStyle = '#FF4A6E';
          gctx.lineWidth = 1;
          gctx.setLineDash([4, 4]);
          gctx.beginPath();
          gctx.moveTo(vsX, padT);
          gctx.lineTo(vsX, padT + plotH);
          gctx.stroke();
          gctx.setLineDash([]);

          gctx.fillStyle = '#FF4A6E';
          gctx.font = '9px JetBrains Mono, monospace';
          gctx.textAlign = 'center';
          gctx.fillText('-V\u2080', vsX, padT - 3);
        }

        // Draw I-V curve
        gctx.strokeStyle = '#4A9EFF';
        gctx.lineWidth = 2;
        gctx.beginPath();
        var first = true;
        for (var px = 0; px <= plotW; px += 1) {
          var v = (px / plotW) * 10 - 5;
          var cur = currentAt(v);
          var cy = padT + plotH * (1 - cur / yMax);
          if (first) { gctx.moveTo(padL + px, cy); first = false; }
          else gctx.lineTo(padL + px, cy);
        }
        gctx.stroke();

        // Saturation line and label
        var satY = padT + plotH * (1 - Isat / yMax);
        gctx.setLineDash([4, 3]);
        gctx.strokeStyle = 'rgba(74, 158, 255, 0.5)';
        gctx.lineWidth = 1;
        gctx.beginPath();
        gctx.moveTo(padL, satY);
        gctx.lineTo(padL + plotW, satY);
        gctx.stroke();
        gctx.setLineDash([]);

        gctx.fillStyle = '#4A9EFF';
        gctx.font = '10px JetBrains Mono, monospace';
        gctx.textAlign = 'right';
        gctx.fillText('I_sat = ' + Isat.toFixed(1) + ' \u00B5A', padL + plotW - 4, satY - 6);

        // Current operating point
        var opV = voltage;
        var opI = currentAt(opV);
        var opX = padL + ((opV + 5) / 10) * plotW;
        var opY = padT + plotH * (1 - opI / yMax);

        gctx.beginPath();
        gctx.arc(opX, opY, 5, 0, Math.PI * 2);
        gctx.fillStyle = '#fff';
        gctx.shadowColor = '#4A9EFF';
        gctx.shadowBlur = 8;
        gctx.fill();
        gctx.shadowBlur = 0;
      } else {
        // No emission text
        gctx.fillStyle = '#555';
        gctx.font = '12px Inter, sans-serif';
        gctx.textAlign = 'center';
        gctx.fillText('No emission', padL + plotW / 2, padT + plotH / 2 - 6);
        gctx.font = '10px JetBrains Mono, monospace';
        gctx.fillText('I = 0', padL + plotW / 2, padT + plotH / 2 + 12);
      }

      requestAnimationFrame(drawGraph);
    }

    // === UPDATE DATA PANEL ===
    function updateData() {
      var E = photonEnergy();
      var W = workFunction();
      var ke = maxKE();
      var Vs = stoppingV();
      var threshF = thresholdFreq();
      var cur = currentAt(voltage);
      var emitting = E > W;

      document.getElementById('dEnergy').textContent = E.toFixed(2) + ' eV';
      document.getElementById('dPhi').textContent = W.toFixed(2) + ' eV';
      document.getElementById('dThresh').innerHTML = threshF.toFixed(1) + ' \u00D710<sup>14</sup> Hz';
      document.getElementById('dKE').textContent = ke.toFixed(2) + ' eV';
      document.getElementById('dVstop').textContent = Vs.toFixed(2) + ' V';
      document.getElementById('dIsat').innerHTML = (emitting ? satCurrent().toFixed(2) : '0.00') + ' &micro;A';
      document.getElementById('dCurrent').innerHTML = cur.toFixed(2) + ' &micro;A';

      var statusEl = document.getElementById('dStatus');
      if (emitting) {
        statusEl.textContent = '\u2713 Emission';
        statusEl.className = 'data-value emission';
      } else {
        statusEl.textContent = '\u2717 No Emission';
        statusEl.className = 'data-value no-emission';
      }
    }

    // === UPDATE SPECTRUM MARKER ===
    function updateSpecMarker() {
      // Spectrum bar: red(left) to UV(right) ‚Äî matches increasing frequency
      var pct = (freq - 4) / (15 - 4) * 100;
      specMarker.style.left = Math.max(0, Math.min(100, pct)) + '%';
    }

    // === CONTROLS ===
    freqSlider.addEventListener('input', function() {
      freq = parseInt(this.value) / 10;
      document.getElementById('freqVal').innerHTML = freq.toFixed(1) + ' \u00D710<sup>14</sup> Hz';
      updateSpecMarker();
      updateData();
    });

    intensitySlider.addEventListener('input', function() {
      intensity = parseInt(this.value);
      document.getElementById('intensityVal').textContent = intensity + '%';
      updateData();
    });

    voltageSlider.addEventListener('input', function() {
      voltage = parseInt(this.value) / 10;
      document.getElementById('voltageVal').textContent = voltage.toFixed(1) + ' V';
      updateData();
    });

    metalSelect.addEventListener('change', function() {
      metalIdx = parseInt(this.value);
      updateData();
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
      photons = [];
      electrons = [];
      freq = 8.6;
      intensity = 50;
      voltage = 0;
      metalIdx = 1;
      freqSlider.value = 86;
      intensitySlider.value = 50;
      voltageSlider.value = 0;
      metalSelect.value = '1';
      document.getElementById('freqVal').innerHTML = '8.6 \u00D710<sup>14</sup> Hz';
      document.getElementById('intensityVal').textContent = '50%';
      document.getElementById('voltageVal').textContent = '0.0 V';
      updateSpecMarker();
      updateData();
    });

    // === INIT ===
    resizeCanvas();
    updateSpecMarker();
    updateData();
    drawSim();
    drawGraph();
  </script>
  <script src="../js/main.js"></script>
</body>
</html>
