<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photoelectric Effect | Physics for Noobs</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî¨</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Delius&family=Nova+Square&family=Cabin+Sketch:wght@400;700&family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&family=Andika:wght@400;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="../js/theme.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script defer src="../js/firebase-config.js"></script>
  <script defer src="../js/auth.js"></script>
  <script defer src="../js/sim-tracker.js"></script>
  <link rel="stylesheet" href="../css/achievements.css">
  <script defer src="../js/achievements-config.js"></script>
  <script defer src="../js/achievements.js"></script>
</head>
<body data-auth-redirect="../simulations.html">
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash"><div class="splash-rocket"><div class="sp-nose"></div><div class="sp-body"></div><div class="sp-window"></div><div class="sp-fin-l"></div><div class="sp-fin-r"></div><div class="sp-flame"></div><div class="sp-glow"></div></div><div class="splash-logo">Physics <span class="brand-accent">for Noobs</span></div><div class="splash-tagline">Learn. Play. Master.</div></div>
<div class="bg-grid"></div>
  <nav class="navbar scrolled"><div class="nav-container"><a href="../index.html" class="nav-logo" id="nav-logo"><div class="logo-icon"><div class="logo-rocket">
  <div class="rocket-nose"></div>
  <div class="rocket-body"></div>
  <div class="rocket-window"></div>
  <div class="rocket-mark">4N</div>
            <div class="rocket-fin-l"></div>
  <div class="rocket-fin-r"></div>
  <div class="rocket-flame"></div>
  <div class="rocket-star"></div>
            <div class="rocket-star"></div>
            <div class="rocket-star"></div>
            <div class="rocket-glow"></div>
<div class="rocket-exhaust"></div>
            <div class="rocket-exhaust"></div>
            <div class="rocket-exhaust"></div>
          </div></div><div class="logo-text"><span class="brand-name">Physics <span class="brand-accent">for Noobs</span></span><span class="brand-tag">LEARN. PLAY. MASTER.</span></div></a><div class="nav-links">
        <div class="nav-item">
          <a href="../index.html" class="nav-link">Home</a>
        </div>
        <div class="nav-item">
          <a href="../about.html" class="nav-link">About Me</a>
        </div>
        <div class="nav-item"><a href="../chapters.html" class="nav-link">Chapters</a></div>        <div class="nav-item">
          <a href="../simulations.html" class="nav-link active">Simulations</a>
        </div>
        <div class="nav-item">
          <a href="../tests.html" class="nav-link">Tests</a>
        </div>
        <div class="nav-item">
          <a href="../flashcards.html" class="nav-link">Flashcards</a>
        </div>
  <script>
    (function(){
      var s=document.getElementById('splash');
      if(sessionStorage.getItem('ae-splash')){s.style.display='none';}
      else{
        sessionStorage.setItem('ae-splash','1');setTimeout(function(){s.classList.add('fade-out');},2200);setTimeout(function(){s.style.display='none';},2700);
      }
    })();
  </script>

  <style>
    .bg-grid, #particles-canvas { display: none !important; }

    .sim-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 24px 40px;
    }

    .sim-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .sim-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.4rem, 2vw, 1.8rem);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }

    .sim-btn {
      padding: 8px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: var(--font-body);
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .sim-btn:hover {
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.3);
      background: rgba(124, 58, 237, 0.08);
    }

    .sim-main-row {
      display: flex;
      gap: 1px;
      background: var(--border-subtle);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      overflow: hidden;
    }

    .canvas-wrap {
      flex: 1;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .canvas-wrap canvas {
      display: block;
      width: 100%;
    }

    .side-graph {
      width: 380px;
      min-width: 300px;
      background: var(--bg-card);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .side-graph h3 {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .side-graph canvas {
      width: 100%;
      flex: 1;
      border-radius: var(--radius-sm);
    }

    /* Controls */
    .controls-bar {
      display: flex;
      align-items: center;
      gap: clamp(16px, 2vw, 32px);
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-family: var(--font-body);
      font-size: clamp(0.85rem, 1vw, 1.05rem);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .control-group input[type="range"] {
      width: clamp(100px, 10vw, 160px);
      -webkit-appearance: none;
      background: var(--border-subtle);
      height: 4px;
      border-radius: 2px;
      outline: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(124, 58, 237, 0.3);
      transition: box-shadow 0.2s;
    }

    .control-group input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
    }

    .control-group .val {
      font-family: var(--font-body);
      font-size: clamp(0.88rem, 1vw, 1.05rem);
      color: var(--text-primary);
      min-width: 60px;
      text-align: right;
    }

    .control-group select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-family: var(--font-body);
      font-size: clamp(0.85rem, 1vw, 1rem);
      cursor: pointer;
      outline: none;
      transition: var(--transition-fast);
    }

    .control-group select:hover {
      border-color: rgba(124, 58, 237, 0.3);
    }

    .control-group select:focus {
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.08);
    }

    .spectrum-bar {
      width: clamp(100px, 10vw, 160px);
      height: 7px;
      border-radius: 3px;
      background: linear-gradient(to right,
        #cc0000 0%,
        #ff4400 20%,
        #ffaa00 33%,
        #ffff00 42%,
        #aaff00 48%,
        #00ff44 58%,
        #00ccff 67%,
        #0044ff 75%,
        #4400ff 85%,
        #8000ff 100%
      );
      margin-top: 2px;
      position: relative;
    }

    .spectrum-marker {
      position: absolute;
      top: -3px;
      width: 4px;
      height: 12px;
      background: #fff;
      border-radius: 2px;
      transform: translateX(-50%);
      box-shadow: 0 0 6px rgba(255,255,255,0.6);
    }

    /* Data panel */
    .data-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-top: 16px;
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0 32px;
    }

    .data-panel h3 {
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 14px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-family: var(--font-body);
      font-size: clamp(0.88rem, 1vw, 1.05rem);
      color: var(--text-muted);
    }

    .data-value {
      font-family: var(--font-body);
      font-size: clamp(0.92rem, 1.1vw, 1.1rem);
      color: var(--text-primary);
      font-weight: 600;
    }

    .data-value.emission {
      color: var(--color-accent);
    }

    .data-value.no-emission {
      color: var(--color-rose);
    }

    /* Equations */
    .equations-section {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-top: 16px;
    }

    .equations-section h3 {
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 14px;
    }

    .equations-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 32px;
    }

    .equation-item {
      font-family: var(--font-body);
      font-size: clamp(1rem, 1.2vw, 1.2rem);
      color: var(--text-primary);
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      white-space: nowrap;
    }

    .equation-item .eq-label {
      color: var(--text-muted);
      font-size: clamp(0.8rem, 0.9vw, 0.9rem);
      display: block;
      margin-bottom: 2px;
    }

    /* Q&A */
    .qa-section {
      margin-top: 32px;
    }

    .qa-section h2 {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .qa-item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      overflow: hidden;
      transition: var(--transition-fast);
    }

    .qa-item:hover {
      border-color: rgba(124, 58, 237, 0.2);
    }

    .qa-q {
      padding: 16px 24px;
      font-family: var(--font-body);
      font-size: clamp(0.95rem, 1.1vw, 1.15rem);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-fast);
    }

    .qa-q:hover {
      background: var(--bg-glass-hover);
    }

    .qa-q::after {
      content: '+';
      font-size: 1.4rem;
      color: var(--color-primary);
      transition: transform 0.2s;
      font-weight: 300;
    }

    .qa-item.open .qa-q::after {
      content: '\2212';
    }

    .qa-a {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .qa-item.open .qa-a {
      max-height: 300px;
    }

    .qa-a-inner {
      padding: 0 24px 18px;
      font-family: var(--font-body);
      font-size: clamp(0.92rem, 1vw, 1.08rem);
      color: var(--text-secondary);
      line-height: 1.75;
    }

    /* Fullscreen mode */
    #simArea {
      background: var(--bg-primary);
    }

    #simArea:fullscreen,
    #simArea:-webkit-full-screen {
      background: var(--bg-primary);
      padding: 16px 24px;
      overflow-y: auto;
    }

    #simArea:fullscreen .side-graph,
    #simArea:-webkit-full-screen .side-graph {
      width: 420px;
    }

    #simArea:fullscreen .controls-bar,
    #simArea:-webkit-full-screen .controls-bar {
      border-radius: 0;
    }

    #simArea:fullscreen .data-panel,
    #simArea:-webkit-full-screen .data-panel {
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .sim-main-row { flex-direction: column; }
      .side-graph { width: 100%; min-width: 0; }
    }
    @media (max-width: 768px) {
      .sim-wrapper { padding: 70px 12px 24px; }
      .controls-bar { gap: 12px; padding: 12px; }
      .control-group input[type="range"] { width: 80px; }
      .spectrum-bar { width: 80px; }
    }
  </style>

  <div class="sim-wrapper">
    <div id="simArea">
    <div class="sim-header">
      <h1>Photoelectric Effect</h1>
      <div style="display:flex;gap:8px;">
        <button class="sim-btn" id="fullscreenBtn">Full Screen</button>
        <button class="sim-btn" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="sim-main-row">
      <div class="canvas-wrap">
        <canvas id="simCanvas"></canvas>
      </div>
      <div class="side-graph">
        <h3>V &ndash; I Characteristic</h3>
        <canvas id="graphCanvas"></canvas>
      </div>
    </div>

    <div class="controls-bar">
      <div class="control-group">
        <label>f</label>
        <div>
          <input type="range" id="freqSlider" min="40" max="150" value="86" step="1">
          <div class="spectrum-bar"><div class="spectrum-marker" id="specMarker"></div></div>
        </div>
        <span class="val" id="freqVal">8.6 &times;10<sup>14</sup> Hz</span>
      </div>
      <div class="control-group">
        <label>Intensity</label>
        <input type="range" id="intensitySlider" min="1" max="100" value="50" step="1">
        <span class="val" id="intensityVal">50%</span>
      </div>
      <div class="control-group">
        <label>Voltage</label>
        <input type="range" id="voltageSlider" min="-50" max="50" value="0" step="1">
        <span class="val" id="voltageVal">0.0 V</span>
      </div>
      <div class="control-group">
        <label>Metal</label>
        <select id="metalSelect">
          <option value="0">Cesium (2.14 eV)</option>
          <option value="1" selected>Sodium (2.28 eV)</option>
          <option value="2">Potassium (2.30 eV)</option>
          <option value="3">Calcium (2.87 eV)</option>
          <option value="4">Aluminum (4.08 eV)</option>
          <option value="5">Zinc (4.33 eV)</option>
          <option value="6">Iron (4.50 eV)</option>
          <option value="7">Copper (4.65 eV)</option>
          <option value="8">Silver (4.73 eV)</option>
          <option value="9">Platinum (5.65 eV)</option>
        </select>
      </div>
    </div>

    <div class="data-panel">
      <h3>Data</h3>
      <div class="data-grid">
        <div class="data-row"><span class="data-label">Photon Energy (E)</span><span class="data-value" id="dEnergy">3.56 eV</span></div>
        <div class="data-row"><span class="data-label">Work Function (&phi;)</span><span class="data-value" id="dPhi">2.28 eV</span></div>
        <div class="data-row"><span class="data-label">Threshold f</span><span class="data-value" id="dThresh">5.51 &times;10<sup>14</sup> Hz</span></div>
        <div class="data-row"><span class="data-label">Max KE</span><span class="data-value" id="dKE">1.28 eV</span></div>
        <div class="data-row"><span class="data-label">Stopping Potential</span><span class="data-value" id="dVstop">1.28 V</span></div>
        <div class="data-row"><span class="data-label">Saturation Current</span><span class="data-value" id="dIsat">5.00 &micro;A</span></div>
        <div class="data-row"><span class="data-label">Current</span><span class="data-value" id="dCurrent">5.00 &micro;A</span></div>
        <div class="data-row"><span class="data-label">Status</span><span class="data-value emission" id="dStatus">Emission</span></div>
      </div>
    </div>
    </div><!-- end #simArea -->

    <div class="equations-section">
      <h3>Key Equations</h3>
      <div class="equations-grid">
        <div class="equation-item">
          <span class="eq-label">Photon Energy</span>
          E = hf
        </div>
        <div class="equation-item">
          <span class="eq-label">Max Kinetic Energy</span>
          KE<sub>max</sub> = hf &minus; &phi;
        </div>
        <div class="equation-item">
          <span class="eq-label">Stopping Potential</span>
          V<sub>0</sub> = KE<sub>max</sub> / e
        </div>
        <div class="equation-item">
          <span class="eq-label">Threshold Frequency</span>
          f<sub>0</sub> = &phi; / h
        </div>
        <div class="equation-item">
          <span class="eq-label">Planck's Constant</span>
          h = 4.136 &times; 10<sup>&minus;15</sup> eV&middot;s
        </div>
      </div>
    </div>

    <div class="qa-section">
      <h2>Questions &amp; Answers</h2>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is the photoelectric effect?</div>
        <div class="qa-a"><div class="qa-a-inner">The emission of electrons from a metal surface when light of sufficient frequency shines on it. Einstein explained this in 1905: light consists of photons with energy E = hf. If hf &gt; &phi; (work function), electrons are emitted with maximum kinetic energy KE<sub>max</sub> = hf &minus; &phi;. This discovery earned Einstein the Nobel Prize in Physics in 1921.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">Why doesn't increasing intensity increase electron energy?</div>
        <div class="qa-a"><div class="qa-a-inner">Intensity means more photons per second, not more energetic photons. Each photon's energy depends only on frequency: E = hf. More photons &rarr; more electrons &rarr; more current, but each electron's maximum KE stays the same. Try it: move the intensity slider and watch the current change while Max KE remains constant.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is stopping potential and how is it measured?</div>
        <div class="qa-a"><div class="qa-a-inner">The minimum reverse voltage needed to stop the most energetic photoelectrons. Apply negative voltage to the anode until the current drops to zero: V<sub>0</sub> = KE<sub>max</sub>/e = (hf &minus; &phi;)/e. It depends on frequency but NOT on intensity. The V&ndash;I graph on the right clearly shows this &mdash; the stopping potential (red dashed line) stays fixed when you change intensity.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">Why is there a threshold frequency?</div>
        <div class="qa-a"><div class="qa-a-inner">A photon must deliver enough energy in a single quantum to overcome the work function &phi;. Below the threshold frequency (hf &lt; &phi;), no single photon has enough energy to liberate an electron &mdash; regardless of how many photons (intensity) or how long you shine the light. The threshold wavelength is &lambda;<sub>0</sub> = hc/&phi; = 1239.84/&phi; nm.</div></div>
      </div>
      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">How did the photoelectric effect prove light is quantized?</div>
        <div class="qa-a"><div class="qa-a-inner">Classical wave theory predicted three things, all wrong: (1) any frequency should eject electrons if intensity is high enough, (2) there should be a time delay before emission starts, (3) kinetic energy should depend on intensity. Einstein's photon model correctly explained: instantaneous emission above threshold, KE depending only on frequency, and current depending on intensity. This was key evidence for quantum mechanics.</div></div>
      </div>
    </div>
  </div>

  <script>
    // === METALS ===
    const metals = [
      { name: 'Cesium',    W: 2.14 },
      { name: 'Sodium',    W: 2.28 },
      { name: 'Potassium', W: 2.30 },
      { name: 'Calcium',   W: 2.87 },
      { name: 'Aluminum',  W: 4.08 },
      { name: 'Zinc',      W: 4.33 },
      { name: 'Iron',      W: 4.50 },
      { name: 'Copper',    W: 4.65 },
      { name: 'Silver',    W: 4.73 },
      { name: 'Platinum',  W: 5.65 }
    ];

    // === STATE ===
    let freq = 8.6;       // √ó10¬π‚Å¥ Hz (default: UV, above sodium threshold)
    let intensity = 50;
    let voltage = 0;
    let metalIdx = 1;
    let photons = [];
    let electrons = [];
    let frameCount = 0;
    let arrivedCount = 0;
    let smoothCurrent = 0;

    // === THEME COLORS (dynamic, responds to light/dark) ===
    var tc = {};
    function updateThemeColors() {
      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      tc = {
        canvasBg: isLight ? '#eaebf2' : '#08081a',
        canvasBgCenter: isLight ? '#f0f1f8' : '#0c0c24',
        grid: isLight ? 'rgba(0,120,200,0.04)' : 'rgba(0,212,255,0.025)',
        tube: isLight ? 'rgba(0,0,0,0.25)' : 'rgba(255,255,255,0.25)',
        tubeGlass: isLight ? 'rgba(200,210,230,0.12)' : 'rgba(100,140,200,0.04)',
        tubeHighlight: isLight ? 'rgba(255,255,255,0.4)' : 'rgba(255,255,255,0.06)',
        vacuum: isLight ? '#555' : '#aaa',
        cathodeA: isLight ? '#555' : '#666',
        cathodeB: isLight ? '#777' : '#999',
        cathodeHighlight: isLight ? '#999' : '#ccc',
        cathodeStroke: isLight ? '#444' : '#888',
        anodeA: isLight ? '#666' : '#777',
        anodeB: isLight ? '#888' : '#aaa',
        anodeHighlight: isLight ? '#aaa' : '#ddd',
        anodeStroke: isLight ? '#555' : '#888',
        label: isLight ? '#222' : '#e0e0e0',
        wire: isLight ? '#222' : '#ddd',
        lampBody: isLight ? '#e0e0e8' : '#1a1a2a',
        lampHighlight: isLight ? '#f8f8ff' : '#2a2a44',
        lampStroke: isLight ? '#aaa' : '#666',
        batteryBody: isLight ? '#e8e8ee' : '#141430',
        batteryStroke: isLight ? '#999' : '#555',
        batteryPos: isLight ? '#cc3333' : '#ff6666',
        batteryNeg: isLight ? '#2255aa' : '#6699dd',
        batteryLine: isLight ? '#111' : '#eee',
        ammeterBg: isLight ? '#f0f0f5' : '#0e0e28',
        ammeterHighlight: isLight ? '#fafafe' : '#1a1a3a',
        ammeterInner: isLight ? '#ccc' : '#333',
        ammeterStroke: isLight ? '#555' : '#888',
        ammeterText: isLight ? '#111' : '#f0f0f0',
        currentOn: isLight ? '#00b377' : '#4AFF8B',
        currentOff: isLight ? '#888' : '#666',
        formulaBg: isLight ? 'rgba(240,240,250,0.92)' : 'rgba(8,8,26,0.92)',
        formulaBorder: isLight ? '#ddd' : '#1a1a3a',
        formulaText: isLight ? '#8888a0' : '#6b6b85',
        noEmBg: isLight ? 'rgba(255,45,117,0.05)' : 'rgba(255,45,117,0.06)',
        noEmText: isLight ? '#cc2266' : '#FF4A6E',
        noEmSub: isLight ? '#bb5577' : '#aa3355',
        emGlow: isLight ? 'rgba(0,179,119,0.04)' : 'rgba(74,255,139,0.04)',
        emGlowBright: isLight ? 'rgba(0,179,119,0.08)' : 'rgba(74,255,139,0.06)',
        // graph
        graphBg: isLight ? '#f0f0f8' : '#0a0a22',
        graphGrid: isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.035)',
        graphAxis: isLight ? '#ccc' : '#2a2a50',
        graphTick: isLight ? '#999' : '#555',
        graphLabel: isLight ? '#888' : '#6b6b85',
        zeroAxis: isLight ? 'rgba(0,100,180,0.18)' : 'rgba(0,212,255,0.2)',
        zeroLabel: isLight ? 'rgba(0,0,0,0.35)' : 'rgba(255,255,255,0.35)',
        noEmitText: isLight ? '#bbb' : '#555',
        // curve colors (consistent)
        curve: '#00d4ff',
        curveSat: isLight ? 'rgba(0,153,204,0.4)' : 'rgba(0,212,255,0.4)',
        stopLine: isLight ? '#cc2266' : '#FF4A6E',
        opPoint: isLight ? '#0099cc' : '#fff',
        opGlow: isLight ? '#0099cc' : '#00d4ff',
        // electrons
        electronColor: isLight ? '0, 80, 220' : '255, 220, 50',
        electronTurned: isLight ? '200, 0, 60' : '255, 80, 120',
        electronCore: isLight ? '0, 0, 0' : '255, 255, 255',
      };
    }
    updateThemeColors();

    // Watch for theme changes
    new MutationObserver(function() { updateThemeColors(); }).observe(
      document.documentElement, { attributes: true, attributeFilter: ['data-theme'] }
    );

    // === DOM ===
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const graphCanvas = document.getElementById('graphCanvas');
    const gctx = graphCanvas.getContext('2d');

    const freqSlider = document.getElementById('freqSlider');
    const intensitySlider = document.getElementById('intensitySlider');
    const voltageSlider = document.getElementById('voltageSlider');
    const metalSelect = document.getElementById('metalSelect');
    const specMarker = document.getElementById('specMarker');

    // === PHYSICS ===
    // h = 4.136√ó10‚Åª¬π‚Åµ eV¬∑s, freq in 10¬π‚Å¥ Hz ‚Üí E = 0.4136 √ó freq
    function photonEnergy() { return 0.4136 * freq; }
    function wavelength() { return 3000 / freq; } // nm, for color mapping
    function workFunction() { return metals[metalIdx].W; }
    function maxKE() { return Math.max(0, photonEnergy() - workFunction()); }
    function stoppingV() { return maxKE(); }
    function thresholdFreq() { return workFunction() / 0.4136; } // √ó10¬π‚Å¥ Hz
    function satCurrent() {
      if (photonEnergy() < workFunction()) return 0;
      return (intensity / 100) * 10;
    }
    function currentAt(V) {
      if (photonEnergy() < workFunction()) return 0;
      var Isat = satCurrent();
      var Vs = stoppingV();
      if (Vs <= 0.001) return 0;
      if (V <= -Vs) return 0;
      // Retarding region: V < 0
      if (V <= 0) {
        var ratio = (V + Vs) / Vs;
        return Isat * 0.75 * ratio * ratio;
      }
      // Accelerating region: V > 0, gradually reach saturation ~+2V
      return Isat * (1 - 0.25 * Math.exp(-V * 2));
    }

    // === WAVELENGTH TO COLOR ===
    function wlToRGB(wl) {
      var r = 0, g = 0, b = 0;
      if (wl < 380) {
        // UV ‚Äî purple
        r = 0.5; g = 0; b = 1;
      } else if (wl < 440) {
        r = -(wl - 440) / (440 - 380);
        g = 0; b = 1;
      } else if (wl < 490) {
        r = 0; g = (wl - 440) / (490 - 440); b = 1;
      } else if (wl < 510) {
        r = 0; g = 1; b = -(wl - 510) / (510 - 490);
      } else if (wl < 580) {
        r = (wl - 510) / (580 - 510); g = 1; b = 0;
      } else if (wl < 645) {
        r = 1; g = -(wl - 645) / (645 - 580); b = 0;
      } else {
        r = 1; g = 0; b = 0;
      }
      // Intensity correction at edges
      var factor;
      if (wl < 380) factor = 0.6;
      else if (wl < 420) factor = 0.3 + 0.7 * (wl - 380) / (420 - 380);
      else if (wl <= 700) factor = 1;
      else factor = 0.3;
      return {
        r: Math.round(r * factor * 255),
        g: Math.round(g * factor * 255),
        b: Math.round(b * factor * 255)
      };
    }

    // === CANVAS SETUP ===
    var dpr = window.devicePixelRatio || 1;

    function resizeCanvas() {
      var isFS = !!(document.fullscreenElement || document.webkitFullscreenElement);
      var wrap = canvas.parentElement;
      var w = wrap.clientWidth;
      var h;
      if (isFS) {
        // Measure actual remaining height: screen - header - controls - data - padding
        var header = document.querySelector('.sim-header');
        var controls = document.querySelector('.controls-bar');
        var data = document.querySelector('.data-panel');
        var used = (header ? header.offsetHeight : 40) +
                   (controls ? controls.offsetHeight : 60) +
                   (data ? data.offsetHeight : 80) + 80; // 80 for padding/margins
        h = Math.max(250, window.innerHeight - used);
      } else {
        h = Math.max(350, Math.min(w * 0.55, window.innerHeight * 0.55));
      }
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Graph canvas ‚Äî match main canvas height
      var gWrap = graphCanvas.parentElement;
      var gw = gWrap.clientWidth - 32;
      var gh = h - 42;
      graphCanvas.width = gw * dpr;
      graphCanvas.height = gh * dpr;
      graphCanvas.style.height = gh + 'px';
      gctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener('resize', resizeCanvas);

    // === DRAWING ===
    function drawSim() {
      var W = canvas.width / dpr;
      var H = canvas.height / dpr;
      var wl = wavelength();
      var color = wlToRGB(wl);
      var emission = photonEnergy() > workFunction();
      // Font scale: base at 700px width, scale up for larger screens
      var fs = Math.max(1, W / 700);

      // Background ‚Äî radial gradient for depth
      var bgGrad = ctx.createRadialGradient(W * 0.45, H * 0.4, W * 0.1, W * 0.5, H * 0.5, W * 0.8);
      bgGrad.addColorStop(0, tc.canvasBgCenter);
      bgGrad.addColorStop(1, tc.canvasBg);
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      // Grid ‚Äî dotted for subtlety
      ctx.strokeStyle = tc.grid;
      ctx.lineWidth = 0.5;
      ctx.setLineDash([1, 6]);
      for (var x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
      for (var y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
      ctx.setLineDash([]);

      // Layout proportions ‚Äî spread to fill canvas
      var tubeL = W * 0.22;
      var tubeR = W * 0.82;
      var tubeT = H * 0.15;
      var tubeB = H * 0.68;
      var cathodeX = W * 0.32;
      var anodeX = W * 0.72;
      var plateTop = tubeT + 20;
      var plateBot = tubeB - 20;

      // === VACUUM TUBE (glass effect) ===
      var tubePad = 15;
      function tubePath() {
        ctx.beginPath();
        ctx.moveTo(tubeL + tubePad, tubeT);
        ctx.lineTo(tubeR - tubePad, tubeT);
        ctx.quadraticCurveTo(tubeR, tubeT, tubeR, tubeT + tubePad);
        ctx.lineTo(tubeR, tubeB - tubePad);
        ctx.quadraticCurveTo(tubeR, tubeB, tubeR - tubePad, tubeB);
        ctx.lineTo(tubeL + tubePad, tubeB);
        ctx.quadraticCurveTo(tubeL, tubeB, tubeL, tubeB - tubePad);
        ctx.lineTo(tubeL, tubeT + tubePad);
        ctx.quadraticCurveTo(tubeL, tubeT, tubeL + tubePad, tubeT);
        ctx.closePath();
      }
      // Glass fill
      tubePath();
      ctx.fillStyle = tc.tubeGlass;
      ctx.fill();
      // Inner glow gradient
      var tubeGlow = ctx.createLinearGradient(tubeL, tubeT, tubeL, tubeB);
      tubeGlow.addColorStop(0, tc.tubeHighlight);
      tubeGlow.addColorStop(0.15, 'transparent');
      tubeGlow.addColorStop(1, 'transparent');
      tubePath();
      ctx.fillStyle = tubeGlow;
      ctx.fill();
      // Stroke
      tubePath();
      ctx.strokeStyle = tc.tube;
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // Top highlight (3D glass)
      ctx.beginPath();
      ctx.moveTo(tubeL + tubePad + 10, tubeT + 3);
      ctx.lineTo(tubeR - tubePad - 10, tubeT + 3);
      ctx.strokeStyle = tc.tubeHighlight;
      ctx.lineWidth = 1;
      ctx.stroke();

      // Vacuum label
      ctx.fillStyle = tc.vacuum;
      ctx.font = Math.round(11 * fs) + 'px Andika, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Vacuum', (tubeL + tubeR) / 2, tubeB - 8);

      // === CATHODE (metallic 3D) ===
      var cathGrad = ctx.createLinearGradient(cathodeX - 8, 0, cathodeX + 8, 0);
      cathGrad.addColorStop(0, tc.cathodeA);
      cathGrad.addColorStop(0.3, tc.cathodeB);
      cathGrad.addColorStop(0.5, tc.cathodeHighlight);
      cathGrad.addColorStop(0.7, tc.cathodeB);
      cathGrad.addColorStop(1, tc.cathodeA);
      ctx.fillStyle = cathGrad;
      ctx.beginPath();
      ctx.roundRect(cathodeX - 6, plateTop, 12, plateBot - plateTop, 2);
      ctx.fill();
      ctx.strokeStyle = tc.cathodeStroke;
      ctx.lineWidth = 0.8;
      ctx.stroke();

      // Emission glow halo on cathode surface
      if (emission) {
        var emGlowGrad = ctx.createLinearGradient(cathodeX + 6, 0, cathodeX + 50, 0);
        emGlowGrad.addColorStop(0, tc.emGlowBright);
        emGlowGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = emGlowGrad;
        ctx.fillRect(cathodeX + 6, plateTop - 4, 44, plateBot - plateTop + 8);
      }

      // === ANODE (metallic 3D) ===
      var anGrad = ctx.createLinearGradient(anodeX - 6, 0, anodeX + 6, 0);
      anGrad.addColorStop(0, tc.anodeA);
      anGrad.addColorStop(0.3, tc.anodeB);
      anGrad.addColorStop(0.5, tc.anodeHighlight);
      anGrad.addColorStop(0.7, tc.anodeB);
      anGrad.addColorStop(1, tc.anodeA);
      ctx.fillStyle = anGrad;
      ctx.beginPath();
      ctx.roundRect(anodeX - 5, plateTop, 10, plateBot - plateTop, 2);
      ctx.fill();
      ctx.strokeStyle = tc.anodeStroke;
      ctx.lineWidth = 0.8;
      ctx.stroke();

      // Labels
      ctx.fillStyle = tc.label;
      ctx.font = Math.round(12 * fs) + 'px Andika, sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText('Cathode', cathodeX - 14, (plateTop + plateBot) / 2 + 4);
      ctx.textAlign = 'left';
      ctx.fillText('Anode', anodeX + 14, (plateTop + plateBot) / 2 + 4);

      // === LIGHT SOURCE (pulsing glow) ===
      var lsX = (tubeL + tubeR) / 2;
      var lsY = H * 0.05;
      var lsR = 20;
      var targetX = cathodeX - 6;
      var targetY = (plateTop + plateBot) / 2;
      var pulse = 0.7 + 0.3 * Math.sin(frameCount * 0.04);

      // Outer glow (pulsing)
      var outerGlow = ctx.createRadialGradient(lsX, lsY, lsR * 0.5, lsX, lsY, lsR + 16);
      outerGlow.addColorStop(0, 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',' + (0.15 * pulse) + ')');
      outerGlow.addColorStop(1, 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0)');
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR + 16, 0, Math.PI * 2);
      ctx.fillStyle = outerGlow;
      ctx.fill();

      // Lamp body
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR, 0, Math.PI * 2);
      var lampGrad = ctx.createRadialGradient(lsX - 4, lsY - 4, 2, lsX, lsY, lsR);
      lampGrad.addColorStop(0, tc.lampHighlight);
      lampGrad.addColorStop(1, tc.lampBody);
      ctx.fillStyle = lampGrad;
      ctx.strokeStyle = tc.lampStroke;
      ctx.lineWidth = 1.2;
      ctx.fill();
      ctx.stroke();

      // Inner glow (pulsing)
      ctx.beginPath();
      ctx.arc(lsX, lsY, lsR - 5, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',' + (0.5 + 0.2 * pulse) + ')';
      ctx.shadowColor = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
      ctx.shadowBlur = 12 + 6 * pulse;
      ctx.fill();
      ctx.shadowBlur = 0;

      // Light beam cone ‚Äî gradient fade
      var beamSpread = 14;
      ctx.beginPath();
      ctx.moveTo(lsX - 5, lsY + lsR);
      ctx.lineTo(targetX - beamSpread, plateTop);
      ctx.lineTo(targetX + beamSpread, plateBot);
      ctx.lineTo(lsX + 5, lsY + lsR);
      ctx.closePath();
      var beamGrad = ctx.createLinearGradient(lsX, lsY + lsR, targetX, targetY);
      beamGrad.addColorStop(0, 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.07)');
      beamGrad.addColorStop(1, 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.02)');
      ctx.fillStyle = beamGrad;
      ctx.fill();

      // Label
      ctx.fillStyle = tc.label;
      ctx.font = Math.round(11 * fs) + 'px Andika, sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText(freq.toFixed(1) + '\u00D710\u00B9\u2074 Hz', lsX + lsR + 8, lsY + 4);

      // === CIRCUIT ===
      var circBot = H - 20;
      var amR = 16;
      var circMid = tubeB + (circBot - tubeB) * 0.5;
      var amY = tubeB + (circMid - tubeB) * 0.6;

      // Battery position ‚Äî centered on bottom wire, raised
      var batX = (cathodeX + anodeX) / 2;
      var batY = circMid + 8;

      ctx.strokeStyle = tc.wire;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';

      // Wire: cathode down, across to battery
      ctx.beginPath();
      ctx.moveTo(cathodeX, plateBot);
      ctx.lineTo(cathodeX, batY);
      ctx.lineTo(batX - 22, batY);
      ctx.stroke();

      // Wire: battery to anode bottom, up to ammeter
      ctx.beginPath();
      ctx.moveTo(batX + 22, batY);
      ctx.lineTo(anodeX, batY);
      ctx.lineTo(anodeX, amY + amR);
      ctx.stroke();

      // Wire: ammeter top to anode plate
      ctx.beginPath();
      ctx.moveTo(anodeX, amY - amR);
      ctx.lineTo(anodeX, plateBot);
      ctx.stroke();
      ctx.lineCap = 'butt';

      // === BATTERY (2-cell realistic style, flips with voltage) ===
      var cellW = 4;
      var cellGap = 6;
      var cellH1 = 18; // tall plate (positive)
      var cellH2 = 10; // short plate (negative)
      // Two cells side by side
      var cells = [
        { cx: batX - cellGap },
        { cx: batX + cellGap }
      ];
      // Outer casing
      ctx.beginPath();
      ctx.roundRect(batX - 18, batY - 14, 36, 28, 5);
      ctx.fillStyle = tc.batteryBody;
      ctx.fill();
      ctx.strokeStyle = tc.batteryStroke;
      ctx.lineWidth = 1.2;
      ctx.stroke();
      // Draw cell plates
      for (var ci = 0; ci < cells.length; ci++) {
        var ccx = cells[ci].cx;
        // Positive plate (tall, thick) ‚Äî left or right depends on voltage
        var pOff = voltage >= 0 ? -cellW : cellW;
        var nOff = voltage >= 0 ? cellW : -cellW;
        // Positive plate
        ctx.fillStyle = tc.batteryPos;
        ctx.fillRect(ccx + pOff - 1.5, batY - cellH1 / 2, 3, cellH1);
        // Negative plate
        ctx.fillStyle = tc.batteryNeg;
        ctx.fillRect(ccx + nOff - 1, batY - cellH2 / 2, 2, cellH2);
      }
      // + and - labels outside casing
      ctx.fillStyle = tc.batteryPos;
      ctx.font = 'bold ' + Math.round(11 * fs) + 'px Andika, sans-serif';
      ctx.textAlign = 'center';
      if (voltage >= 0) {
        ctx.fillText('+', batX - 24, batY + 4);
        ctx.fillStyle = tc.batteryNeg;
        ctx.fillText('\u2013', batX + 24, batY + 4);
      } else {
        ctx.fillText('+', batX + 24, batY + 4);
        ctx.fillStyle = tc.batteryNeg;
        ctx.fillText('\u2013', batX - 24, batY + 4);
      }

      // === AMMETER (polished) ===
      var amGrad = ctx.createRadialGradient(anodeX - 3, amY - 3, 1, anodeX, amY, amR);
      amGrad.addColorStop(0, tc.ammeterHighlight);
      amGrad.addColorStop(1, tc.ammeterBg);
      ctx.beginPath();
      ctx.arc(anodeX, amY, amR, 0, Math.PI * 2);
      ctx.fillStyle = amGrad;
      ctx.fill();
      // Outer ring
      ctx.strokeStyle = tc.ammeterStroke;
      ctx.lineWidth = 2;
      ctx.stroke();
      // Inner ring for depth
      ctx.beginPath();
      ctx.arc(anodeX, amY, amR - 3, 0, Math.PI * 2);
      ctx.strokeStyle = tc.ammeterInner;
      ctx.lineWidth = 0.8;
      ctx.stroke();

      // A label
      ctx.fillStyle = tc.ammeterText;
      ctx.font = 'bold ' + Math.round(14 * fs) + 'px Andika, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('A', anodeX, amY);
      ctx.textBaseline = 'alphabetic';

      // === CURRENT READING (to the right of ammeter) ===
      var curVal = currentAt(voltage);
      var curStr = curVal.toFixed(2) + ' \u00B5A';
      var curZero = curVal < 0.005;
      var curColor = !emission ? tc.currentOff : (curZero ? tc.stopLine : tc.currentOn);
      var curBorder = !emission ? tc.formulaBorder : (curZero ? 'rgba(255,45,117,0.3)' : 'rgba(0,255,170,0.25)');
      ctx.font = 'bold ' + Math.round(14 * fs) + 'px JetBrains Mono, monospace';
      var curW = ctx.measureText(curStr).width + 18;
      var curH = Math.round(24 * fs);
      var curPx = anodeX + amR + 10;
      var curPy = amY - curH / 2;
      ctx.fillStyle = tc.formulaBg;
      ctx.beginPath();
      ctx.roundRect(curPx, curPy, curW, curH, 4);
      ctx.fill();
      ctx.strokeStyle = curBorder;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(curPx, curPy, curW, curH, 4);
      ctx.stroke();
      ctx.fillStyle = curColor;
      ctx.textAlign = 'left';
      ctx.fillText(curStr, curPx + 9, curPy + curH * 0.68);

      // === VOLTAGE READING (above battery casing) ===
      var vStr2 = (voltage >= 0 ? '+' : '') + voltage.toFixed(1) + ' V';
      ctx.font = 'bold ' + Math.round(12 * fs) + 'px JetBrains Mono, monospace';
      var vW = ctx.measureText(vStr2).width + 14;
      var vH = Math.round(20 * fs);
      var vPx = batX - vW / 2;
      var vPy = batY - 14 - vH - 6;
      ctx.fillStyle = tc.formulaBg;
      ctx.beginPath();
      ctx.roundRect(vPx, vPy, vW, vH, 4);
      ctx.fill();
      ctx.strokeStyle = 'rgba(124,58,237,0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(vPx, vPy, vW, vH, 4);
      ctx.stroke();
      ctx.fillStyle = 'rgba(124,58,237,0.8)';
      ctx.textAlign = 'center';
      ctx.fillText(vStr2, batX, vPy + vH * 0.68);

      // === PHOTON PARTICLES (diagonal from top-center to cathode) ===
      frameCount++;
      var spawnRate = Math.max(1, Math.floor(8 - (intensity / 100) * 7));
      // Direction vector from light source to cathode surface
      var dx = targetX - lsX;
      var dy = targetY - lsY;
      var dist = Math.sqrt(dx * dx + dy * dy);
      var dirX = dx / dist;
      var dirY = dy / dist;

      if (frameCount % spawnRate === 0) {
        var spread = (Math.random() - 0.5) * 8;
        photons.push({
          x: lsX + spread * dirY,
          y: lsY + lsR + Math.abs(spread * dirX),
          speed: 2.5 + Math.random() * 1.5,
          wave: Math.random() * Math.PI * 2,
          hitY: plateTop + Math.random() * (plateBot - plateTop),
          trail: []
        });
      }

      // Cap photon count
      if (photons.length > 80) photons.splice(0, photons.length - 80);

      photons = photons.filter(function(p) {
        // Store trail positions
        p.trail.push({ x: p.x, y: p.y });
        if (p.trail.length > 4) p.trail.shift();

        p.x += dirX * p.speed;
        p.y += dirY * p.speed;
        p.wave += 0.15;

        // Hit the cathode surface
        if (p.x <= cathodeX + 6 && p.y >= plateTop - 5) {
          if (emission) {
            var ke = Math.random() * maxKE();
            var speed = 0.8 + (ke / Math.max(0.01, maxKE())) * 2.5;
            var angle = (Math.random() - 0.5) * Math.PI * 0.8;
            electrons.push({
              x: cathodeX + 8,
              y: Math.max(plateTop, Math.min(plateBot, p.y)),
              vx: speed * Math.cos(angle),
              vy: speed * Math.sin(angle),
              ke: ke,
              life: 300,
              turned: false,
              trail: []
            });
          }
          return false;
        }

        if (p.y > tubeB + 10 || p.x < tubeL - 10) return false;

        // Draw trailing dots (fading)
        for (var ti = 0; ti < p.trail.length; ti++) {
          var ta = (ti + 1) / (p.trail.length + 1) * 0.4;
          var tr = 2 + ti * 0.3;
          ctx.beginPath();
          ctx.arc(p.trail[ti].x, p.trail[ti].y, tr, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',' + ta + ')';
          ctx.fill();
        }

        // Draw photon (main dot)
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.9)';
        ctx.shadowColor = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
        ctx.shadowBlur = 10;
        ctx.fill();
        ctx.shadowBlur = 0;

        // Wave trail
        ctx.strokeStyle = 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',0.25)';
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        for (var i = 0; i < 15; i++) {
          var tx = p.x - dirX * i * 2 + Math.sin(p.wave - i * 0.5) * dirY * 3;
          var ty = p.y - dirY * i * 2 - Math.sin(p.wave - i * 0.5) * dirX * 3;
          if (i === 0) ctx.moveTo(tx, ty);
          else ctx.lineTo(tx, ty);
        }
        ctx.stroke();

        return true;
      });

      // === ELECTRON PARTICLES ===
      if (electrons.length > 100) electrons.splice(0, electrons.length - 100);

      arrivedCount = 0;
      electrons = electrons.filter(function(e) {
        e.life--;
        if (e.life <= 0) return false;

        // Store trail
        if (!e.trail) e.trail = [];
        e.trail.push({ x: e.x, y: e.y });
        if (e.trail.length > 4) e.trail.shift();

        var accel = 0;
        if (voltage >= 0) {
          accel = 0.01 + voltage * 0.015;
        } else {
          accel = voltage * 0.015;
        }
        e.vx += accel;

        if (voltage > 0) {
          e.vy *= 0.98;
        }

        if (e.vx < 0) {
          e.turned = true;
        }

        e.x += e.vx;
        e.y += e.vy;

        if (e.x >= anodeX - 5 && !e.turned) {
          arrivedCount++;
          return false;
        }

        if (e.x < cathodeX - 10) return false;
        if (e.y < plateTop || e.y > plateBot) return false;
        if (e.x > anodeX + 20) return false;

        var alpha = Math.min(1, e.life / 60);
        var eColor = e.turned ? tc.electronTurned : tc.electronColor;

        // Draw trail
        for (var ti = 0; ti < e.trail.length; ti++) {
          var ta = (ti + 1) / (e.trail.length + 1) * alpha * 0.4;
          ctx.beginPath();
          ctx.arc(e.trail[ti].x, e.trail[ti].y, 3 - ti * 0.4, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(' + eColor + ',' + ta + ')';
          ctx.fill();
        }

        // Draw electron
        ctx.beginPath();
        ctx.arc(e.x, e.y, 4.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + eColor + ',' + alpha + ')';
        ctx.shadowColor = 'rgba(' + eColor + ',0.6)';
        ctx.shadowBlur = 8;
        ctx.fill();
        ctx.shadowBlur = 0;
        // bright core
        ctx.beginPath();
        ctx.arc(e.x, e.y, 1.8, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + tc.electronCore + ',' + (alpha * 0.7) + ')';
        ctx.fill();

        return true;
      });

      // === NO EMISSION INDICATOR ===
      if (!emission) {
        ctx.fillStyle = tc.noEmBg;
        ctx.fillRect(cathodeX - 8, plateTop, 16, plateBot - plateTop);

        ctx.fillStyle = tc.noEmText;
        ctx.font = 'bold ' + Math.round(15 * fs) + 'px Andika, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No Emission', (cathodeX + anodeX) / 2, (tubeT + tubeB) / 2 - 8);
        ctx.font = Math.round(12 * fs) + 'px Andika, sans-serif';
        ctx.fillStyle = tc.noEmSub;
        ctx.fillText('E < \u03C6  (' + photonEnergy().toFixed(2) + ' < ' + workFunction().toFixed(2) + ' eV)', (cathodeX + anodeX) / 2, (tubeT + tubeB) / 2 + 12);
      }

      requestAnimationFrame(drawSim);
    }

    // === V-I GRAPH ===
    function drawGraph() {
      var w = graphCanvas.width / dpr;
      var h = graphCanvas.height / dpr;

      gctx.fillStyle = tc.graphBg;
      gctx.fillRect(0, 0, w, h);

      var padL = 50, padR = 18, padT = 22, padB = 40;
      var plotW = w - padL - padR;
      var plotH = h - padT - padB;
      var Isat = satCurrent();
      var Vs = stoppingV();
      var emitting = photonEnergy() > workFunction();
      var yMax = 12;
      var gfs = Math.min(1.15, Math.max(0.85, w / 300)); // graph font scale, capped

      // Grid lines
      gctx.strokeStyle = tc.graphGrid;
      gctx.lineWidth = 1;
      for (var i = 1; i <= 4; i++) {
        var gy = padT + plotH * (1 - i / 4);
        gctx.beginPath();
        gctx.moveTo(padL, gy);
        gctx.lineTo(padL + plotW, gy);
        gctx.stroke();
      }
      for (var i = 1; i <= 9; i++) {
        var gx = padL + plotW * i / 10;
        gctx.beginPath();
        gctx.moveTo(gx, padT);
        gctx.lineTo(gx, padT + plotH);
        gctx.stroke();
      }

      // V=0 axis (prominent)
      var zeroX = padL + (5 / 10) * plotW;
      gctx.strokeStyle = tc.zeroAxis;
      gctx.lineWidth = 1.5;
      gctx.beginPath();
      gctx.moveTo(zeroX, padT);
      gctx.lineTo(zeroX, padT + plotH);
      gctx.stroke();

      // I=0 axis (prominent)
      gctx.beginPath();
      gctx.moveTo(padL, padT + plotH);
      gctx.lineTo(padL + plotW, padT + plotH);
      gctx.stroke();

      // Outer axes (bold)
      gctx.strokeStyle = tc.label;
      gctx.lineWidth = 1.5;
      gctx.beginPath();
      gctx.moveTo(padL, padT);
      gctx.lineTo(padL, padT + plotH);
      gctx.lineTo(padL + plotW, padT + plotH);
      gctx.stroke();

      // Axis title labels
      gctx.fillStyle = tc.label;
      gctx.font = 'bold ' + Math.round(13 * gfs) + 'px Andika, sans-serif';
      gctx.textAlign = 'center';
      gctx.fillText('V (volts)', padL + plotW / 2, h - 6);
      gctx.save();
      gctx.translate(14, padT + plotH / 2);
      gctx.rotate(-Math.PI / 2);
      gctx.fillText('I (\u00B5A)', 0, 0);
      gctx.restore();

      // Tick labels on X
      gctx.textAlign = 'center';
      gctx.fillStyle = tc.label;
      gctx.font = Math.round(11 * gfs) + 'px JetBrains Mono, monospace';
      for (var v = -5; v <= 5; v += 2.5) {
        var tx = padL + ((v + 5) / 10) * plotW;
        gctx.fillText(v.toFixed(1), tx, padT + plotH + 18);
        // Tick mark
        gctx.strokeStyle = tc.label;
        gctx.lineWidth = 1;
        gctx.beginPath();
        gctx.moveTo(tx, padT + plotH);
        gctx.lineTo(tx, padT + plotH + 5);
        gctx.stroke();
      }
      // "0" label on V=0
      gctx.fillStyle = tc.zeroLabel;
      gctx.font = 'bold ' + Math.round(11 * gfs) + 'px JetBrains Mono, monospace';
      gctx.fillText('0', zeroX, padT + plotH + 18);

      // Tick labels on Y
      gctx.textAlign = 'right';
      gctx.fillStyle = tc.label;
      gctx.font = Math.round(11 * gfs) + 'px JetBrains Mono, monospace';
      for (var i = 0; i <= 4; i++) {
        var yVal = (i / 4) * yMax;
        var ty = padT + plotH * (1 - i / 4);
        gctx.fillText(yVal.toFixed(0), padL - 8, ty + 4);
        // Tick mark
        gctx.strokeStyle = tc.label;
        gctx.lineWidth = 1;
        gctx.beginPath();
        gctx.moveTo(padL - 4, ty);
        gctx.lineTo(padL, ty);
        gctx.stroke();
      }

      if (emitting && Isat > 0) {
        // Stopping potential marker
        if (Vs > 0 && Vs <= 5) {
          var vsX = padL + ((-Vs + 5) / 10) * plotW;
          gctx.strokeStyle = tc.stopLine;
          gctx.lineWidth = 1.5;
          gctx.setLineDash([5, 4]);
          gctx.beginPath();
          gctx.moveTo(vsX, padT);
          gctx.lineTo(vsX, padT + plotH);
          gctx.stroke();
          gctx.setLineDash([]);

          // Label with background
          gctx.fillStyle = tc.stopLine;
          gctx.font = 'bold ' + Math.round(12 * gfs) + 'px Andika, sans-serif';
          gctx.textAlign = 'center';
          gctx.fillText('-V\u2080', vsX, padT - 6);
        }

        // Draw I-V curve with gradient fill underneath
        gctx.beginPath();
        var first = true;
        for (var px = 0; px <= plotW; px += 1) {
          var v = (px / plotW) * 10 - 5;
          var cur = currentAt(v);
          var cy = padT + plotH * (1 - cur / yMax);
          if (first) { gctx.moveTo(padL + px, cy); first = false; }
          else gctx.lineTo(padL + px, cy);
        }
        // Fill underneath
        gctx.lineTo(padL + plotW, padT + plotH);
        gctx.lineTo(padL, padT + plotH);
        gctx.closePath();
        var fillGrad = gctx.createLinearGradient(0, padT, 0, padT + plotH);
        fillGrad.addColorStop(0, 'rgba(0, 212, 255, 0.08)');
        fillGrad.addColorStop(1, 'rgba(0, 212, 255, 0)');
        gctx.fillStyle = fillGrad;
        gctx.fill();

        // Draw curve line
        gctx.strokeStyle = tc.curve;
        gctx.lineWidth = 2.5;
        gctx.shadowColor = tc.curve;
        gctx.shadowBlur = 4;
        gctx.beginPath();
        first = true;
        for (var px = 0; px <= plotW; px += 1) {
          var v = (px / plotW) * 10 - 5;
          var cur = currentAt(v);
          var cy = padT + plotH * (1 - cur / yMax);
          if (first) { gctx.moveTo(padL + px, cy); first = false; }
          else gctx.lineTo(padL + px, cy);
        }
        gctx.stroke();
        gctx.shadowBlur = 0;

        // Saturation line and label
        var satY = padT + plotH * (1 - Isat / yMax);
        gctx.setLineDash([5, 4]);
        gctx.strokeStyle = tc.curveSat;
        gctx.lineWidth = 1.5;
        gctx.beginPath();
        gctx.moveTo(padL, satY);
        gctx.lineTo(padL + plotW, satY);
        gctx.stroke();
        gctx.setLineDash([]);

        gctx.fillStyle = tc.curve;
        gctx.font = 'bold ' + Math.round(12 * gfs) + 'px Andika, sans-serif';
        gctx.textAlign = 'right';
        gctx.fillText('I sat = ' + Isat.toFixed(1) + ' \u00B5A', padL + plotW - 4, satY - 8);

        // Current operating point (larger, with crosshairs)
        var opV = voltage;
        var opI = currentAt(opV);
        var opX = padL + ((opV + 5) / 10) * plotW;
        var opY = padT + plotH * (1 - opI / yMax);

        // Crosshair lines to axes
        gctx.setLineDash([3, 3]);
        gctx.strokeStyle = 'rgba(255,255,255,0.12)';
        gctx.lineWidth = 1;
        gctx.beginPath();
        gctx.moveTo(opX, opY);
        gctx.lineTo(opX, padT + plotH);
        gctx.stroke();
        gctx.beginPath();
        gctx.moveTo(opX, opY);
        gctx.lineTo(padL, opY);
        gctx.stroke();
        gctx.setLineDash([]);

        // Operating point dot (pulsing)
        var opPulse = 5 + 1.5 * Math.sin(Date.now() * 0.004);
        gctx.beginPath();
        gctx.arc(opX, opY, opPulse, 0, Math.PI * 2);
        gctx.fillStyle = tc.opPoint;
        gctx.shadowColor = tc.opGlow;
        gctx.shadowBlur = 10 + 4 * Math.sin(Date.now() * 0.004);
        gctx.fill();
        gctx.shadowBlur = 0;

        // Value label near operating point
        gctx.fillStyle = tc.curve;
        gctx.font = Math.round(11 * gfs) + 'px JetBrains Mono, monospace';
        gctx.textAlign = 'left';
        gctx.fillText(opI.toFixed(2) + ' \u00B5A', opX + 10, opY - 4);
      } else {
        // No emission text
        gctx.fillStyle = tc.label;
        gctx.font = Math.round(15 * gfs) + 'px Andika, sans-serif';
        gctx.textAlign = 'center';
        gctx.fillText('No emission', padL + plotW / 2, padT + plotH / 2 - 6);
        gctx.font = Math.round(13 * gfs) + 'px Andika, sans-serif';
        gctx.fillText('I = 0', padL + plotW / 2, padT + plotH / 2 + 16);
      }

      requestAnimationFrame(drawGraph);
    }

    // === UPDATE DATA PANEL ===
    function updateData() {
      var E = photonEnergy();
      var W = workFunction();
      var ke = maxKE();
      var Vs = stoppingV();
      var threshF = thresholdFreq();
      var cur = currentAt(voltage);
      var emitting = E > W;

      document.getElementById('dEnergy').textContent = E.toFixed(2) + ' eV';
      document.getElementById('dPhi').textContent = W.toFixed(2) + ' eV';
      document.getElementById('dThresh').innerHTML = threshF.toFixed(1) + ' \u00D710<sup>14</sup> Hz';
      document.getElementById('dKE').textContent = ke.toFixed(2) + ' eV';
      document.getElementById('dVstop').textContent = Vs.toFixed(2) + ' V';
      document.getElementById('dIsat').innerHTML = (emitting ? satCurrent().toFixed(2) : '0.00') + ' &micro;A';
      document.getElementById('dCurrent').innerHTML = cur.toFixed(2) + ' &micro;A';

      var statusEl = document.getElementById('dStatus');
      if (emitting) {
        statusEl.innerHTML = '<span style="color:var(--color-accent)">\u2713</span> Emission';
        statusEl.className = 'data-value emission';
      } else {
        statusEl.innerHTML = '<span style="color:var(--color-rose)">\u2717</span> No Emission';
        statusEl.className = 'data-value no-emission';
      }
    }

    // === UPDATE SPECTRUM MARKER ===
    function updateSpecMarker() {
      // Spectrum bar: red(left) to UV(right) ‚Äî matches increasing frequency
      var pct = (freq - 4) / (15 - 4) * 100;
      specMarker.style.left = Math.max(0, Math.min(100, pct)) + '%';
    }

    // === CONTROLS ===
    freqSlider.addEventListener('input', function() {
      freq = parseInt(this.value) / 10;
      document.getElementById('freqVal').innerHTML = freq.toFixed(1) + ' \u00D710<sup>14</sup> Hz';
      updateSpecMarker();
      updateData();
    });

    intensitySlider.addEventListener('input', function() {
      intensity = parseInt(this.value);
      document.getElementById('intensityVal').textContent = intensity + '%';
      updateData();
    });

    voltageSlider.addEventListener('input', function() {
      voltage = parseInt(this.value) / 10;
      document.getElementById('voltageVal').textContent = voltage.toFixed(1) + ' V';
      updateData();
    });

    metalSelect.addEventListener('change', function() {
      metalIdx = parseInt(this.value);
      updateData();
    });

    // === FULLSCREEN ===
    var simArea = document.getElementById('simArea');
    var fsBtn = document.getElementById('fullscreenBtn');

    fsBtn.addEventListener('click', function() {
      if (document.fullscreenElement || document.webkitFullscreenElement) {
        (document.exitFullscreen || document.webkitExitFullscreen).call(document);
      } else {
        (simArea.requestFullscreen || simArea.webkitRequestFullscreen).call(simArea);
      }
    });

    function onFSChange() {
      var isFS = !!(document.fullscreenElement || document.webkitFullscreenElement);
      fsBtn.textContent = isFS ? 'Exit Full Screen' : 'Full Screen';
      // Resize multiple times as DOM settles into fullscreen layout
      resizeCanvas();
      setTimeout(resizeCanvas, 100);
      setTimeout(resizeCanvas, 300);
    }

    document.addEventListener('fullscreenchange', onFSChange);
    document.addEventListener('webkitfullscreenchange', onFSChange);

    document.getElementById('resetBtn').addEventListener('click', function() {
      photons = [];
      electrons = [];
      freq = 8.6;
      intensity = 50;
      voltage = 0;
      metalIdx = 1;
      freqSlider.value = 86;
      intensitySlider.value = 50;
      voltageSlider.value = 0;
      metalSelect.value = '1';
      document.getElementById('freqVal').innerHTML = '8.6 \u00D710<sup>14</sup> Hz';
      document.getElementById('intensityVal').textContent = '50%';
      document.getElementById('voltageVal').textContent = '0.0 V';
      updateSpecMarker();
      updateData();
    });

    // === INIT ===
    resizeCanvas();
    updateSpecMarker();
    updateData();
    drawSim();
    drawGraph();
  </script>
  <script src="../js/main.js"></script>
  <script src="../js/auth-gate.js"></script>
</body>
</html>
