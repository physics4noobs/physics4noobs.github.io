<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kinematics Simulation | Axomiya Engineer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Delius&family=Nova+Square&family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&family=Andika:wght@400;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/achievements.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>">
  <script src="../js/theme.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script defer src="../js/firebase-config.js"></script>
  <script defer src="../js/auth.js"></script>
  <script defer src="../js/sim-tracker.js"></script>
  <script defer src="../js/achievements-config.js"></script>
  <script defer src="../js/achievements.js"></script>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash"><div class="splash-pendulum"><div class="sp-mount"></div><div class="sp-pivot"></div><div class="sp-arm"><div class="sp-rod"></div><div class="sp-bob"><div class="sp-glow"></div></div></div></div><div class="splash-logo">Axomiya Engineer</div><div class="splash-tagline">Lets Make Physics Fun</div></div>
<div class="bg-grid"></div>
  <nav class="navbar scrolled">
    <div class="nav-container">
      <a href="../index.html" class="nav-logo" id="nav-logo">
        <div class="logo-icon"><div class="logo-pendulum"><div class="pendulum-mount"></div><div class="pendulum-pivot"></div><div class="pendulum-arm"><div class="pendulum-rod"></div><div class="pendulum-bob"><div class="bob-glow"></div></div></div></div></div>
        <div class="logo-text"><span class="brand-name">Axomiya Engineer</span><span class="brand-tag">LETS MAKE PHYSICS FUN</span></div>
      </a>
      <div class="nav-links">
        <div class="nav-item">
          <a href="../index.html" class="nav-link">Home</a>
        </div>
        <div class="nav-item">
          <a href="../about.html" class="nav-link">About Me</a>
        </div>
        <div class="nav-item"><a href="../chapters.html" class="nav-link">Chapters</a></div>        <div class="nav-item">
          <a href="../simulations.html" class="nav-link active">Simulations</a>
        </div>
        <div class="nav-item">
          <a href="../tests.html" class="nav-link">Tests</a>
        </div>
        <div class="nav-item">
          <a href="../flashcards.html" class="nav-link">Flashcards</a>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
        <button class="auth-btn" id="auth-login-btn"><svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Sign in</button>
        <div class="user-menu nav-item" id="auth-user-menu" style="display:none;"><img class="user-avatar" id="auth-user-avatar" src="" alt="User"><span class="user-name" id="auth-user-name"></span><div class="dropdown"><a href="../progress.html"><div class="dd-icon">&#128200;</div> My Progress</a><div class="dropdown-divider"></div><a href="#" id="auth-logout-btn"><div class="dd-icon">&#128682;</div> Sign Out</a></div></div>
        <a href="../index.html#contact" class="nav-cta">Contact Me</a>
      </div>
      <button class="nav-toggle" aria-label="Menu"><span></span><span></span><span></span></button>
    </div>
  </nav>
  <script>
    (function(){
      var s=document.getElementById('splash');
      if(sessionStorage.getItem('ae-splash')){s.style.display='none';}
      else{
        sessionStorage.setItem('ae-splash','1');setTimeout(function(){s.classList.add('fade-out');},2200);setTimeout(function(){s.style.display='none';},2700);
      }
    })();
  </script>

  <style>
    .bg-grid, #particles-canvas { display: none !important; }

    .sim-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 24px 40px;
    }

    .sim-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .sim-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.4rem, 2vw, 1.8rem);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }

    .sim-btn {
      padding: 8px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: var(--font-body);
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .sim-btn:hover {
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.3);
      background: rgba(124, 58, 237, 0.08);
    }

    .sim-btn.primary {
      background: rgba(124, 58, 237, 0.15);
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.3);
    }

    .sim-btn.primary:hover {
      background: rgba(124, 58, 237, 0.25);
    }

    .sim-main-row {
      display: flex;
      gap: 1px;
      background: var(--border-subtle);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      overflow: hidden;
    }

    .canvas-wrap {
      flex: 1;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .canvas-wrap canvas {
      display: block;
      width: 100%;
    }

    .side-data {
      width: 280px;
      min-width: 240px;
      background: var(--bg-card);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .side-data h3 {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .side-data .data-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* Legend */
    .legend-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-top: none;
      min-height: 18px;
    }

    .legend-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-body);
      font-size: clamp(0.72rem, 0.9vw, 0.82rem);
      color: var(--text-muted);
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Controls */
    .controls-bar {
      display: flex;
      align-items: center;
      gap: clamp(16px, 2vw, 32px);
      padding: 18px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-family: var(--font-body);
      font-size: clamp(0.85rem, 1vw, 1.05rem);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .control-group input[type="range"] {
      width: clamp(100px, 10vw, 160px);
      -webkit-appearance: none;
      background: var(--border-subtle);
      height: 4px;
      border-radius: 2px;
      outline: none;
    }

    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(124, 58, 237, 0.3);
      transition: box-shadow 0.2s;
    }

    .control-group input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
    }

    .control-group input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 6px rgba(124, 58, 237, 0.3);
    }

    .control-group .val {
      font-family: var(--font-body);
      font-size: clamp(0.88rem, 1vw, 1.05rem);
      color: var(--text-primary);
      min-width: 36px;
      text-align: right;
    }

    .control-group input[type="number"] {
      width: 58px;
      padding: 4px 6px;
      font-family: var(--font-mono);
      font-size: 0.88rem;
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      text-align: center;
      -moz-appearance: textfield;
      outline: none;
      transition: border-color 0.2s;
    }

    .control-group input[type="number"]:focus {
      border-color: var(--color-primary);
    }

    .control-group input[type="number"]::-webkit-inner-spin-button,
    .control-group input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .data-grid {
      display: flex;
      flex-direction: column;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-family: var(--font-body);
      font-size: clamp(0.88rem, 1vw, 1.05rem);
      color: var(--text-muted);
    }

    .data-value {
      font-family: var(--font-body);
      font-size: clamp(0.92rem, 1.1vw, 1.1rem);
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Equations */
    .equations-section {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-top: 16px;
    }

    .equations-section h3 {
      font-family: var(--font-display);
      font-size: clamp(0.8rem, 1vw, 1rem);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 14px;
    }

    .equations-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 32px;
    }

    .equation-item {
      font-family: var(--font-body);
      font-size: clamp(1rem, 1.2vw, 1.2rem);
      color: var(--text-primary);
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      white-space: nowrap;
    }

    .equation-item .eq-label {
      color: var(--text-muted);
      font-size: clamp(0.8rem, 0.9vw, 0.9rem);
      display: block;
      margin-bottom: 2px;
    }

    /* Q&A */
    .qa-section {
      margin-top: 32px;
    }

    .qa-section h2 {
      font-family: var(--font-display);
      font-size: clamp(0.9rem, 1.1vw, 1.1rem);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .qa-item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      overflow: hidden;
      transition: var(--transition-fast);
    }

    .qa-item:hover {
      border-color: rgba(124, 58, 237, 0.2);
    }

    .qa-q {
      padding: 16px 24px;
      font-family: var(--font-body);
      font-size: clamp(0.95rem, 1.1vw, 1.15rem);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-fast);
    }

    .qa-q:hover {
      background: var(--bg-glass-hover);
    }

    .qa-q::after {
      content: '+';
      font-size: 1.4rem;
      color: var(--color-primary);
      transition: transform 0.2s;
      font-weight: 300;
    }

    .qa-item.open .qa-q::after {
      content: '\2212';
    }

    .qa-a {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .qa-item.open .qa-a {
      max-height: 300px;
    }

    .qa-a-inner {
      padding: 0 24px 18px;
      font-family: var(--font-body);
      font-size: clamp(0.92rem, 1vw, 1.08rem);
      color: var(--text-secondary);
      line-height: 1.75;
    }

    /* Fullscreen */
    #simArea {
      background: var(--bg-primary);
      position: relative;
    }

    #simArea:fullscreen,
    #simArea:-webkit-full-screen {
      background: var(--bg-primary);
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #simArea:fullscreen .sim-main-row,
    #simArea:-webkit-full-screen .sim-main-row {
      flex: 1;
      min-height: 0;
    }

    #simArea:fullscreen .canvas-wrap,
    #simArea:-webkit-full-screen .canvas-wrap {
      flex: 1;
      min-height: 0;
    }

    #simArea:fullscreen .side-data,
    #simArea:-webkit-full-screen .side-data {
      width: 320px;
    }

    #simArea:fullscreen .controls-bar,
    #simArea:-webkit-full-screen .controls-bar {
      border-radius: 0;
    }

    @media (max-width: 900px) {
      .sim-main-row { flex-direction: column; }
      .side-data { width: 100%; min-width: unset; border-radius: 0; }
      .canvas-wrap { border-radius: var(--radius-md) var(--radius-md) 0 0; }
    }
    @media (max-width: 768px) {
      .sim-wrapper { padding: 70px 12px 24px; }
      .sim-header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .controls-bar { gap: 12px; padding: 12px; }
      .control-group input[type="range"] { width: 80px; }
    }

    /* === Tutorial Overlay === */
    .sim-tutorial {
      position: absolute;
      inset: 0;
      z-index: 50;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(0.5px);
      -webkit-backdrop-filter: blur(0.5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease;
      cursor: pointer;
      border-radius: var(--radius-md);
    }

    .tut-hint {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      font-size: 0.88rem;
      pointer-events: none;
    }

    .tut-arrows-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .tut-label {
      font-family: var(--font-body);
      background: rgba(255,255,255,0.92);
      color: #1a1a2e;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.82rem;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }

    .tut-dismiss {
      position: absolute;
      bottom: 38%;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 32px;
      font-family: var(--font-body);
      font-size: 0.95rem;
      font-weight: 700;
      color: #1a1a2e;
      background: #fff;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 4px 16px rgba(124,58,237,0.3);
      transition: background 0.2s, transform 0.2s;
    }

    .tut-dismiss:hover {
      background: #e8e0f8;
      transform: translateX(-50%) scale(1.04);
    }

    @media (max-width: 900px) {
      .sim-tutorial { display: none !important; }
      #helpBtn { display: none; }
    }
  </style>

  <div class="sim-wrapper">
    <div id="simArea">
    <div class="sim-header">
      <h1>Projectile Motion</h1>
      <div style="display:flex;gap:8px;">
        <button class="sim-btn" id="resetBtn">Reset</button>
        <button class="sim-btn" id="fullscreenBtn">Full Screen</button>
        <button class="sim-btn" id="helpBtn">? Help</button>
      </div>
    </div>

    <div class="sim-main-row">
      <div class="canvas-wrap">
        <canvas id="simCanvas"></canvas>
      </div>
      <div class="side-data">
        <h3>Data</h3>
        <div class="data-grid">
          <div class="data-row"><span class="data-label">Initial Velocity (u)</span><span class="data-value" id="d-u">&mdash;</span></div>
          <div class="data-row"><span class="data-label">Launch Angle (&theta;)</span><span class="data-value" id="d-theta">&mdash;</span></div>
          <div class="data-row"><span class="data-label">Time of Flight</span><span class="data-value" id="d-tof">&mdash;</span></div>
          <div class="data-row"><span class="data-label">Range</span><span class="data-value" id="d-range">&mdash;</span></div>
          <div class="data-row"><span class="data-label">Max Height</span><span class="data-value" id="d-hmax">&mdash;</span></div>
          <div class="data-row"><span class="data-label">V<sub>x</sub></span><span class="data-value" id="d-vx">&mdash;</span></div>
          <div class="data-row"><span class="data-label">V<sub>y</sub></span><span class="data-value" id="d-vy">&mdash;</span></div>
        </div>
      </div>
    </div>
    <div class="legend-bar" id="legendBar"></div>

    <div class="controls-bar">
      <div class="control-group">
        <label>u</label>
        <input type="range" id="velSlider" min="80" max="100" value="90">
        <input type="number" id="velInput" min="80" max="100" value="90" step="1">
        <label>m/s</label>
      </div>
      <div class="control-group">
        <label>&theta;</label>
        <input type="range" id="angleSlider" min="5" max="85" value="30">
        <input type="number" id="angleInput" min="5" max="85" value="30" step="1">
        <label>&deg;</label>
      </div>
      <button class="sim-btn primary" id="launchBtn" style="margin-right:auto;">Launch</button>
    </div>

    <!-- Tutorial Overlay -->
    <div class="sim-tutorial" id="simTutorial" style="display:none;">
      <svg class="tut-arrows-svg" id="tutArrowsSvg"></svg>

      <div class="tut-hint" id="tutLaunch">
        <div class="tut-label">Click Launch to fire the projectile</div>
      </div>
      <div class="tut-hint" id="tutVel">
        <div class="tut-label">Adjust initial velocity (u)</div>
      </div>
      <div class="tut-hint" id="tutAngle">
        <div class="tut-label">Set the launch angle (theta)</div>
      </div>
      <div class="tut-hint" id="tutData">
        <div class="tut-label">Live data updates here</div>
      </div>

      <button class="tut-dismiss">Got it, let's start!</button>
    </div>

    </div><!-- end #simArea -->

    <div class="equations-section">
      <h3>Key Equations</h3>
      <div class="equations-grid">
        <div class="equation-item">
          <span class="eq-label">Range</span>
          R = u&sup2; sin(2&theta;) / g
        </div>
        <div class="equation-item">
          <span class="eq-label">Max Height</span>
          H = u&sup2; sin&sup2;&theta; / 2g
        </div>
        <div class="equation-item">
          <span class="eq-label">Time of Flight</span>
          T = 2u sin&theta; / g
        </div>
        <div class="equation-item">
          <span class="eq-label">Trajectory</span>
          y = x tan&theta; &minus; gx&sup2; / 2u&sup2;cos&sup2;&theta;
        </div>
      </div>
    </div>

    <div class="qa-section">
      <h2>Test Your Understanding</h2>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">At what angle is the range maximum?</div>
        <div class="qa-a"><div class="qa-a-inner">
          <strong>45&deg;</strong>. Range = u&sup2; sin(2&theta;) / g. The function sin(2&theta;) reaches its maximum value of 1 when 2&theta; = 90&deg;, which means &theta; = 45&deg;.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">When are the ranges of two projectiles equal?</div>
        <div class="qa-a"><div class="qa-a-inner">
          When launched at <strong>complementary angles</strong> (&theta; and 90&deg;&minus;&theta;) with the same speed. This is because sin(2&theta;) = sin(2(90&deg;&minus;&theta;)). For example, 30&deg; and 60&deg; give equal ranges. Try it in the simulation!
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What happens to time of flight as angle increases?</div>
        <div class="qa-a"><div class="qa-a-inner">
          It <strong>increases</strong>. Time of flight T = 2u sin&theta; / g. As &theta; goes from 0&deg; to 90&deg;, sin&theta; increases from 0 to 1, so T increases. A vertically launched projectile stays in the air the longest.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">At what angle is maximum height equal to the range?</div>
        <div class="qa-a"><div class="qa-a-inner">
          At <strong>&theta; = tan<sup>&minus;1</sup>(4) &approx; 76&deg;</strong>. Setting H<sub>max</sub> = R gives u&sup2;sin&sup2;&theta;/2g = u&sup2;sin(2&theta;)/g. Simplifying: sin&theta;/2 = 2cos&theta;, so tan&theta; = 4.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is the shape of a projectile's trajectory?</div>
        <div class="qa-a"><div class="qa-a-inner">
          A <strong>parabola</strong>. Eliminating time from the equations of motion: y = x tan&theta; &minus; gx&sup2; / (2u&sup2;cos&sup2;&theta;). This is quadratic in x, which is the equation of a parabola.
        </div></div>
      </div>
    </div>
  </div>

  <script>
    // === THEME COLORS ===
    var tc = {};
    function updateThemeColors() {
      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      tc = {
        canvasBg: isLight ? '#e8eaf0' : '#08081a',
        canvasBgCenter: isLight ? '#f0f2f8' : '#10102a',
        grid: isLight ? 'rgba(0,120,200,0.06)' : 'rgba(0,212,255,0.035)',
        axis: isLight ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.15)',
        axisLabel: isLight ? 'rgba(0,0,0,0.35)' : 'rgba(255,255,255,0.3)',
        tickText: isLight ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.25)',
        // Cannon
        cannonBody: isLight ? '#888' : '#555',
        cannonStroke: isLight ? '#555' : '#888',
        cannonMuzzle: isLight ? '#777' : '#444',
        cannonBase: isLight ? '#777' : '#444',
        cannonBaseStroke: isLight ? '#444' : '#666',
        cannonHub: isLight ? '#555' : '#333',
        // Ground
        groundTop: isLight ? '#5dba2f' : '#3a8520',
        groundBody: isLight ? '#3da010' : '#256515',
        groundLine: isLight ? 'rgba(60,200,30,0.55)' : 'rgba(50,180,30,0.45)',
        // Markers
        markerDash: isLight ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.12)',
        markerText: isLight ? 'rgba(0,0,0,0.35)' : 'rgba(255,255,255,0.3)',
      };
    }
    updateThemeColors();
    new MutationObserver(function() { updateThemeColors(); drawScene(); })
      .observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    // === STATE ===
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const G = 9.8;

    const COLORS = ['#4A9EFF','#FF4A6E','#4AFF8B','#FFB84A','#B44AFF','#FF4AD4','#4AFFF0','#FFF04A'];
    let colorIndex = 0;
    let launches = [];
    let animId = null;

    const velSlider = document.getElementById('velSlider');
    const angleSlider = document.getElementById('angleSlider');
    const velInput = document.getElementById('velInput');
    const angleInput = document.getElementById('angleInput');
    const legendBar = document.getElementById('legendBar');

    function syncVel(val) {
      val = Math.max(80, Math.min(100, Math.round(parseFloat(val) || 80)));
      velSlider.value = val;
      velInput.value = val;
      drawScene();
    }
    function syncAngle(val) {
      val = Math.max(5, Math.min(85, Math.round(parseFloat(val) || 5)));
      angleSlider.value = val;
      angleInput.value = val;
      drawScene();
    }
    velSlider.oninput = function() { syncVel(this.value); };
    velInput.onchange = function() { syncVel(this.value); };
    angleSlider.oninput = function() { syncAngle(this.value); };
    angleInput.onchange = function() { syncAngle(this.value); };

    // === CANVAS SIZING ===
    const PADDING = 50;
    let originX, originY, scaleX, scaleY, canvasW, canvasH;

    function resizeCanvas() {
      const wrap = canvas.parentElement;
      const isFS = !!document.fullscreenElement;
      const w = wrap.clientWidth;
      const h = isFS ? wrap.clientHeight : Math.max(350, window.innerHeight * 0.55);
      const dpr = window.devicePixelRatio || 1;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      canvasW = w;
      canvasH = h;
      originX = PADDING;
      originY = canvasH - PADDING;
      const maxRange = 1050;
      scaleX = (canvasW - PADDING * 2) / maxRange;
      scaleY = scaleX;

      drawScene();
    }

    window.addEventListener('resize', resizeCanvas);

    // === AUDIO ===
    let audioCtx = null;
    function playBoom() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(80, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.15);
      gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 0.2);
      const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.08, audioCtx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 3);
      const noise = audioCtx.createBufferSource();
      noise.buffer = buf;
      const ng = audioCtx.createGain();
      ng.gain.setValueAtTime(0.3, audioCtx.currentTime);
      ng.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      noise.connect(ng);
      ng.connect(audioCtx.destination);
      noise.start(audioCtx.currentTime);
    }

    // === DRAWING â€” MAIN CANVAS ===
    const fs = () => Math.max(1, canvasW / 700);

    function drawBg() {
      // Radial gradient background
      const grad = ctx.createRadialGradient(canvasW / 2, canvasH / 2, 0, canvasW / 2, canvasH / 2, canvasW * 0.7);
      grad.addColorStop(0, tc.canvasBgCenter);
      grad.addColorStop(1, tc.canvasBg);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvasW, canvasH);

      // Dotted grid
      ctx.fillStyle = tc.grid;
      for (let x = PADDING; x < canvasW - PADDING; x += 50) {
        for (let y = PADDING / 2; y < originY; y += 50) {
          ctx.beginPath();
          ctx.arc(x, y, 1, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Ground texture strip
      const groundH = 8;
      const gGrad = ctx.createLinearGradient(0, originY, 0, originY + groundH);
      gGrad.addColorStop(0, tc.groundTop);
      gGrad.addColorStop(1, tc.groundBody);
      ctx.fillStyle = gGrad;
      ctx.fillRect(PADDING, originY, canvasW - PADDING * 2, groundH);
      // Grass blades
      ctx.strokeStyle = tc.groundLine;
      ctx.lineWidth = 1;
      for (let gx = PADDING; gx < canvasW - PADDING; gx += 6) {
        const h = 3 + Math.random() * 4;
        ctx.beginPath();
        ctx.moveTo(gx, originY);
        ctx.lineTo(gx + (Math.random() - 0.5) * 3, originY - h);
        ctx.stroke();
      }

      // Axes
      ctx.strokeStyle = tc.axis;
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(originX, originY); ctx.lineTo(canvasW - PADDING, originY); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(originX, originY); ctx.lineTo(originX, PADDING / 2); ctx.stroke();

      // Tick marks
      ctx.fillStyle = tc.tickText;
      ctx.font = (9 * fs()) + 'px Andika, sans-serif';
      ctx.textAlign = 'center';
      const tickSpacingM = getTickSpacing();
      for (let m = tickSpacingM; m * scaleX + originX < canvasW - PADDING; m += tickSpacingM) {
        const px = originX + m * scaleX;
        ctx.strokeStyle = tc.axis;
        ctx.beginPath(); ctx.moveTo(px, originY); ctx.lineTo(px, originY + 4); ctx.stroke();
        ctx.fillText(m + 'm', px, originY + 14 * fs());
      }
      ctx.textAlign = 'right';
      for (let m = tickSpacingM; originY - m * scaleY > PADDING; m += tickSpacingM) {
        const py = originY - m * scaleY;
        ctx.strokeStyle = tc.axis;
        ctx.beginPath(); ctx.moveTo(originX - 4, py); ctx.lineTo(originX, py); ctx.stroke();
        ctx.fillText(m + 'm', originX - 6, py + 3);
      }

    }

    function getTickSpacing() {
      const maxVisible = (canvasW - PADDING * 2) / scaleX;
      if (maxVisible > 800) return 200;
      if (maxVisible > 400) return 100;
      if (maxVisible > 200) return 50;
      return 20;
    }

    function drawCannon(angle) {
      const rad = angle * Math.PI / 180;
      const cx = originX;
      const cy = originY;
      const barrelLen = 28;
      const barrelW = 10;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(-rad);

      ctx.fillStyle = tc.cannonBody;
      ctx.strokeStyle = tc.cannonStroke;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(-4, -barrelW / 2, barrelLen, barrelW, 2);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = tc.cannonMuzzle;
      ctx.fillRect(barrelLen - 4, -barrelW / 2 - 2, 6, barrelW + 4);

      ctx.restore();

      // Base (wheel)
      ctx.fillStyle = tc.cannonBase;
      ctx.strokeStyle = tc.cannonBaseStroke;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(cx, cy, 12, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = tc.cannonHub;
      ctx.beginPath();
      ctx.arc(cx, cy, 4, 0, Math.PI * 2);
      ctx.fill();
    }

    function drawTrails() {
      for (let l of launches) {
        if (l.trail.length < 2) continue;
        ctx.save();
        if (!l.done) {
          ctx.shadowColor = l.color;
          ctx.shadowBlur = 6;
        }
        ctx.strokeStyle = l.done ? hexToRgba(l.color, 0.35) : l.color;
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(l.trail[0].px, l.trail[0].py);
        for (let i = 1; i < l.trail.length; i++) {
          ctx.lineTo(l.trail[i].px, l.trail[i].py);
        }
        ctx.stroke();
        ctx.restore();

        // Angle label near launch point
        if (l.trail.length > 5) {
          const labelPt = l.trail[Math.min(8, l.trail.length - 1)];
          ctx.save();
          ctx.font = (9 * fs()) + 'px Andika, sans-serif';
          ctx.fillStyle = l.done ? hexToRgba(l.color, 0.5) : l.color;
          ctx.textAlign = 'left';
          ctx.fillText(l.angle + '\u00B0', labelPt.px + 6, labelPt.py - 6);
          ctx.restore();
        }

        // Peak marker
        if (l.peakIdx !== undefined && l.trail[l.peakIdx]) {
          const pk = l.trail[l.peakIdx];
          ctx.save();
          ctx.fillStyle = l.done ? hexToRgba(l.color, 0.5) : l.color;
          ctx.beginPath();
          ctx.moveTo(pk.px, pk.py - 6);
          ctx.lineTo(pk.px + 4, pk.py);
          ctx.lineTo(pk.px, pk.py + 6);
          ctx.lineTo(pk.px - 4, pk.py);
          ctx.closePath();
          ctx.fill();
          // Height label
          if (l.hmax) {
            ctx.font = (9 * fs()) + 'px Andika, sans-serif';
            ctx.fillStyle = l.done ? hexToRgba(l.color, 0.5) : l.color;
            ctx.textAlign = 'center';
            ctx.fillText(l.hmax.toFixed(1) + 'm', pk.px, pk.py - 10);
          }
          ctx.restore();
        }
      }
    }

    function drawArrow(x0, y0, x1, y1, color, label) {
      const headLen = 7;
      const dx = x1 - x0;
      const dy = y1 - y0;
      const ang = Math.atan2(dy, dx);

      ctx.save();
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';

      // Shaft
      ctx.beginPath();
      ctx.moveTo(x0, y0);
      ctx.lineTo(x1, y1);
      ctx.stroke();

      // Arrowhead
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x1 - headLen * Math.cos(ang - 0.4), y1 - headLen * Math.sin(ang - 0.4));
      ctx.lineTo(x1 - headLen * Math.cos(ang + 0.4), y1 - headLen * Math.sin(ang + 0.4));
      ctx.closePath();
      ctx.fill();

      // Label
      if (label) {
        ctx.font = (8 * fs()) + 'px Andika, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(label, (x0 + x1) / 2 + (dy > 0 ? -10 : dy < 0 ? -10 : 0), (y0 + y1) / 2 + (dx > 0 ? -6 : 6));
      }
      ctx.restore();
    }

    function drawBalls() {
      const vecScale = 0.6; // pixels per m/s for vector length
      var activeLaunches = [];
      for (let l of launches) {
        if (l.done || l.trail.length === 0) continue;
        activeLaunches.push(l);
        const last = l.trail[l.trail.length - 1];
        const bx = last.px;
        const by = last.py;

        // Draw ball
        ctx.save();
        ctx.shadowColor = l.color;
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(bx, by, 5, 0, Math.PI * 2);
        ctx.fillStyle = l.color;
        ctx.fill();
        ctx.restore();

        // Compute current velocities
        const currentVy = l.vy - G * l.t; // positive = upward

        // Vx vector (horizontal, constant) â€” always points right
        const vxLen = l.vx * vecScale;
        drawArrow(bx, by, bx + vxLen, by, '#4AFF8B', 'Vx');

        // Vy vector (vertical, changing) â€” points up when positive, down when negative
        const vyLen = currentVy * vecScale;
        drawArrow(bx, by, bx, by - vyLen, '#FF4A6E', 'Vy');
      }

      // Update live velocity display
      if (activeLaunches.length === 1) {
        var al = activeLaunches[0];
        var curVy = al.vy - G * al.t;
        document.getElementById('d-vx').textContent = al.vx.toFixed(1) + ' m/s';
        document.getElementById('d-vy').textContent = curVy.toFixed(1) + ' m/s';
      } else if (activeLaunches.length > 1) {
        document.getElementById('d-vx').textContent = 'Invalid';
        document.getElementById('d-vy').textContent = 'Invalid';
      }
    }

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    // === PARTICLE EFFECTS ===
    let particles = [];

    function spawnSmoke(x, y, angle) {
      const rad = angle * Math.PI / 180;
      for (let i = 0; i < 12; i++) {
        const spread = (Math.random() - 0.5) * 0.8;
        const speed = 1 + Math.random() * 2;
        particles.push({
          x, y,
          vx: Math.cos(rad + spread) * speed * 0.5 - Math.random() * 0.5,
          vy: -Math.sin(rad + spread) * speed * 0.5 - Math.random() * 0.5,
          life: 1,
          decay: 0.02 + Math.random() * 0.02,
          size: 3 + Math.random() * 4,
          type: 'smoke'
        });
      }
    }

    function spawnImpact(x, y, color) {
      for (let i = 0; i < 10; i++) {
        const ang = -Math.PI * Math.random();
        const speed = 1 + Math.random() * 3;
        particles.push({
          x, y,
          vx: Math.cos(ang) * speed,
          vy: Math.sin(ang) * speed - Math.random() * 2,
          life: 1,
          decay: 0.03 + Math.random() * 0.02,
          size: 2 + Math.random() * 3,
          color: color,
          type: 'impact'
        });
      }
      // Dust puff
      for (let i = 0; i < 6; i++) {
        particles.push({
          x: x + (Math.random() - 0.5) * 20,
          y: y - Math.random() * 4,
          vx: (Math.random() - 0.5) * 1.5,
          vy: -0.3 - Math.random() * 0.8,
          life: 1,
          decay: 0.015 + Math.random() * 0.01,
          size: 4 + Math.random() * 5,
          type: 'dust'
        });
      }
    }

    function updateAndDrawParticles() {
      const isLight = document.documentElement.getAttribute('data-theme') === 'light';
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= p.decay;
        if (p.type === 'impact') p.vy += 0.15; // gravity on impact bits

        if (p.life <= 0) {
          particles.splice(i, 1);
          continue;
        }

        ctx.save();
        ctx.globalAlpha = p.life;
        if (p.type === 'smoke' || p.type === 'dust') {
          const smokeColor = isLight ? 'rgba(120,120,130,' : 'rgba(180,180,200,';
          ctx.fillStyle = smokeColor + (p.life * 0.4) + ')';
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size * (1.5 - p.life * 0.5), 0, Math.PI * 2);
          ctx.fill();
        } else if (p.type === 'impact') {
          ctx.fillStyle = p.color || '#FFB84A';
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();
      }
    }

    // === DASHED RANGE/HEIGHT MARKERS ===
    function drawMarkers() {
      for (let l of launches) {
        if (!l.done) continue;
        const tof = 2 * l.vy / G;
        const range = l.vx * tof;
        const hmax = l.vy * l.vy / (2 * G);

        const landPx = originX + range * scaleX;
        const peakPy = originY - hmax * scaleY;
        const alpha = 0.4;

        ctx.save();
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;

        // Vertical dashed line at landing point (range)
        ctx.strokeStyle = hexToRgba(l.color, 0.2);
        ctx.beginPath();
        ctx.moveTo(landPx, originY);
        ctx.lineTo(landPx, originY - 14);
        ctx.stroke();

        // Range label
        ctx.fillStyle = hexToRgba(l.color, alpha);
        ctx.font = (8 * fs()) + 'px Andika, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(range.toFixed(0) + 'm', landPx, originY - 16);

        ctx.setLineDash([]);
        ctx.restore();
      }
    }

    function drawScene() {
      drawBg();
      drawMarkers();
      drawTrails();
      drawBalls();
      updateAndDrawParticles();
      drawCannon(parseInt(angleSlider.value));
    }

    // === PHYSICS ===
    const BARREL_LEN = 28;

    function cannonTip(angleDeg) {
      const rad = angleDeg * Math.PI / 180;
      return {
        px: originX + Math.cos(rad) * BARREL_LEN,
        py: originY - Math.sin(rad) * BARREL_LEN
      };
    }

    function toScreen(x, y) {
      return { px: originX + x * scaleX, py: originY - y * scaleY };
    }

    function launchProjectile() {
      const u = parseInt(velSlider.value);
      const angle = parseInt(angleSlider.value);
      const rad = angle * Math.PI / 180;
      const vx = u * Math.cos(rad);
      const vy = u * Math.sin(rad);
      const color = COLORS[colorIndex % COLORS.length];
      colorIndex++;

      const tip = cannonTip(angle);
      const hmax = vy * vy / (2 * G);
      const proj = {
        u, angle, vx, vy, t: 0, color, hmax,
        trail: [{ px: tip.px, py: tip.py }],  // start from cannon tip
        active: true,
        done: false,
        peakIdx: undefined,
        peakReached: false
      };
      launches.push(proj);

      // Update data panel
      const tof = (2 * u * Math.sin(rad) / G).toFixed(2);
      const range = (u * u * Math.sin(2 * rad) / G).toFixed(1);
      document.getElementById('d-u').textContent = u + ' m/s';
      document.getElementById('d-theta').textContent = angle + '\u00B0';
      document.getElementById('d-tof').textContent = tof + ' s';
      document.getElementById('d-range').textContent = range + ' m';
      document.getElementById('d-hmax').textContent = hmax.toFixed(1) + ' m';

      // Show live velocity â€” "Invalid" if multiple active launches
      var activeCount = 0;
      for (var li = 0; li < launches.length; li++) { if (!launches[li].done) activeCount++; }
      if (activeCount > 1) {
        document.getElementById('d-vx').textContent = 'Invalid';
        document.getElementById('d-vy').textContent = 'Invalid';
      } else {
        document.getElementById('d-vx').textContent = vx.toFixed(1) + ' m/s';
        document.getElementById('d-vy').textContent = vy.toFixed(1) + ' m/s';
      }

      updateLegend();
      playBoom();
      // Launch smoke from cannon tip
      spawnSmoke(tip.px, tip.py, angle);
      if (!animId) animate();
    }

    function updateLegend() {
      legendBar.innerHTML = '';
      for (let l of launches) {
        const chip = document.createElement('div');
        chip.className = 'legend-chip';
        chip.innerHTML = '<div class="legend-dot" style="background:' + l.color + '"></div>' + l.angle + '\u00B0 @ ' + l.u + ' m/s';
        legendBar.appendChild(chip);
      }
    }

    function animate() {
      let anyActive = false;

      for (let l of launches) {
        if (!l.active) continue;
        l.t += 0.025;
        const x = l.vx * l.t;
        const y = l.vy * l.t - 0.5 * G * l.t * l.t;

        // Track peak
        if (!l.peakReached && y < (l.trail.length > 0 ? (l.vy * (l.t - 0.025) - 0.5 * G * (l.t - 0.025) * (l.t - 0.025)) : 0)) {
          l.peakReached = true;
          l.peakIdx = Math.max(0, l.trail.length - 1);
        }

        if (y <= 0 && l.t > 0.05) {
          const tLand = 2 * l.vy / G;
          const xLand = l.vx * tLand;
          const landScreen = toScreen(xLand, 0);
          l.trail.push(landScreen);
          l.active = false;
          l.done = true;
          spawnImpact(landScreen.px, landScreen.py, l.color);
          if (window.AchievementEngine) AchievementEngine.check();
        } else {
          l.trail.push(toScreen(x, Math.max(y, 0)));
          anyActive = true;
        }
      }

      drawScene();

      if (anyActive || particles.length > 0) {
        animId = requestAnimationFrame(animate);
      } else {
        animId = null;
      }
    }

    function resetSim() {
      if (animId) { cancelAnimationFrame(animId); animId = null; }
      launches = [];
      particles = [];
      colorIndex = 0;
      legendBar.innerHTML = '';
      document.getElementById('d-u').innerHTML = '&mdash;';
      document.getElementById('d-theta').innerHTML = '&mdash;';
      document.getElementById('d-tof').innerHTML = '&mdash;';
      document.getElementById('d-range').innerHTML = '&mdash;';
      document.getElementById('d-hmax').innerHTML = '&mdash;';
      document.getElementById('d-vx').innerHTML = '&mdash;';
      document.getElementById('d-vy').innerHTML = '&mdash;';
      drawScene();
    }

    // === FULLSCREEN ===
    document.getElementById('fullscreenBtn').addEventListener('click', function() {
      const el = document.getElementById('simArea');
      if (!document.fullscreenElement) {
        (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen).call(el);
      } else {
        (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document);
      }
    });

    document.addEventListener('fullscreenchange', function() {
      setTimeout(resizeCanvas, 100);
      setTimeout(resizeCanvas, 300);
    });

    // === EVENT LISTENERS ===
    document.getElementById('launchBtn').addEventListener('click', launchProjectile);
    document.getElementById('resetBtn').addEventListener('click', resetSim);

    document.addEventListener('keydown', function(e) {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        launchProjectile();
      }
    });

    // === TUTORIAL OVERLAY ===
    function showTutorial() {
      var el = document.getElementById('simTutorial');
      el.style.display = '';
      el.offsetHeight; // force reflow for transition
      el.style.opacity = '1';
      positionTutorialHints();
    }

    window.addEventListener('resize', function() {
      if (document.getElementById('simTutorial').style.display !== 'none') {
        positionTutorialHints();
      }
    });

    function dismissTutorial() {
      var el = document.getElementById('simTutorial');
      el.style.opacity = '0';
      setTimeout(function() { el.style.display = 'none'; }, 400);
      localStorage.setItem('tut-kinematics', '1');
    }

    function drawCurvedArrow(svg, x1, y1, x2, y2) {
      var ns = 'http://www.w3.org/2000/svg';
      var dx = x2 - x1;
      var dy = y2 - y1;
      var cx1 = x1 + dx * 0.2;
      var cy1 = y1 + dy * 0.6;
      var cx2 = x1 + dx * 0.8;
      var cy2 = y1 + dy * 0.4;

      var path = document.createElementNS(ns, 'path');
      path.setAttribute('d',
        'M' + x1 + ',' + y1 +
        ' C' + cx1 + ',' + cy1 +
        ' ' + cx2 + ',' + cy2 +
        ' ' + x2 + ',' + y2
      );
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', 'rgba(255,255,255,0.85)');
      path.setAttribute('stroke-width', '2');
      path.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path);

      var angle = Math.atan2(y2 - cy2, x2 - cx2);
      var headLen = 10;
      var a1x = x2 - headLen * Math.cos(angle - 0.4);
      var a1y = y2 - headLen * Math.sin(angle - 0.4);
      var a2x = x2 - headLen * Math.cos(angle + 0.4);
      var a2y = y2 - headLen * Math.sin(angle + 0.4);
      var arrow = document.createElementNS(ns, 'polygon');
      arrow.setAttribute('points',
        x2 + ',' + y2 + ' ' +
        a1x + ',' + a1y + ' ' +
        a2x + ',' + a2y
      );
      arrow.setAttribute('fill', 'rgba(255,255,255,0.85)');
      svg.appendChild(arrow);
    }

    function positionTutorialHints() {
      var area = document.getElementById('simArea');
      var areaRect = area.getBoundingClientRect();
      var svg = document.getElementById('tutArrowsSvg');
      svg.innerHTML = '';

      var targets = [
        { hint: 'tutLaunch', el: document.getElementById('launchBtn'),   type: 'bottom' },
        { hint: 'tutVel',    el: document.getElementById('velSlider'),   type: 'bottom' },
        { hint: 'tutAngle',  el: document.getElementById('angleSlider'), type: 'bottom' },
        { hint: 'tutData',   el: document.querySelector('.side-data'),   type: 'side'   }
      ];

      var placed = [];

      for (var i = 0; i < targets.length; i++) {
        var t = targets[i];
        var hintEl = document.getElementById(t.hint);
        var elRect = t.el.getBoundingClientRect();
        var cx = elRect.left + elRect.width / 2 - areaRect.left;
        var cy = elRect.top - areaRect.top;

        if (t.type === 'side') {
          var midY = elRect.top + elRect.height / 2 - areaRect.top;
          hintEl.style.top = midY + 'px';
          hintEl.style.right = (areaRect.right - elRect.left + 8) + 'px';
          hintEl.style.left = '';
          hintEl.style.transform = '';

          var hRect = hintEl.getBoundingClientRect();
          var arrowStartX = hRect.right - areaRect.left + 4;
          var arrowStartY = hRect.top + hRect.height / 2 - areaRect.top;
          var arrowEndX = elRect.left - areaRect.left - 2;
          var arrowEndY = midY;
          drawCurvedArrow(svg, arrowStartX, arrowStartY, arrowEndX, arrowEndY);
          continue;
        }

        hintEl.style.left = cx + 'px';
        hintEl.style.transform = 'translateX(-50%)';
        hintEl.style.top = '0px';

        var hintRect = hintEl.getBoundingClientRect();
        var hintW = hintRect.width;
        var hintH = hintRect.height;

        var desiredTop = cy - 50;
        var hintLeft = cx - hintW / 2;
        var hintRight = hintLeft + hintW;

        var finalTop = desiredTop;
        for (var j = 0; j < placed.length; j++) {
          var p = placed[j];
          if (hintRight > p.left && hintLeft < p.right) {
            if (finalTop + hintH > p.top && finalTop < p.bottom) {
              finalTop = p.top - hintH - 8;
            }
          }
        }

        hintEl.style.top = finalTop + 'px';
        placed.push({
          left: hintLeft,
          right: hintRight,
          top: finalTop,
          bottom: finalTop + hintH
        });

        var arrowStartX = cx;
        var arrowStartY = finalTop + hintH + 2;
        var arrowEndX = cx;
        var arrowEndY = cy + 2;
        drawCurvedArrow(svg, arrowStartX, arrowStartY, arrowEndX, arrowEndY);
      }
    }

    // Auto-show on first visit
    if (!localStorage.getItem('tut-kinematics')) {
      showTutorial();
    }

    // Dismiss on click anywhere on overlay
    document.getElementById('simTutorial').addEventListener('click', dismissTutorial);

    // Help button re-shows overlay
    document.getElementById('helpBtn').addEventListener('click', showTutorial);

    // Init
    resizeCanvas();
  </script>
  <script src="../js/main.js"></script>
</body>
</html>
