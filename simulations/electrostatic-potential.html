<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Electrostatic Potential | Physics for Noobs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Jost:wght@300;400;500;600;700&family=Delius&family=Nova+Square&family=Yatra+One&family=Quintessential&family=Cabin+Sketch:wght@400;700&family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&family=Andika:wght@400;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/achievements.css">
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#050510">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="../images/icon-192.svg">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>">
  <script src="../js/theme.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script defer src="../js/firebase-config.js"></script>
  <script defer src="../js/auth.js?v=58"></script>
  <script defer src="../js/ranking.js"></script>
  <script defer src="../js/sim-tracker.js"></script>
  <script defer src="../js/achievements-config.js"></script>
  <script defer src="../js/achievements.js"></script>
</head>
<body data-auth-redirect="../simulations.html">
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash"><div class="splash-rocket"><div class="sp-nose"></div><div class="sp-body"></div><div class="sp-window"></div><div class="sp-fin-l"></div><div class="sp-fin-r"></div><div class="sp-flame"></div><div class="sp-glow"></div></div><div class="splash-logo"><span class="brand-initial">P</span>hysics <span class="brand-accent">for Noobs</span></div><div class="splash-tagline">Free Therapy For Physics Trauma</div></div>
<div class="bg-grid"></div>
  <nav class="navbar scrolled">
    <div class="nav-container">
      <a href="../index.html" class="nav-logo" id="nav-logo">
        <div class="logo-icon"><div class="logo-pendulum"><div class="pendulum-pivot"></div><div class="pendulum-arm"><div class="pendulum-string"></div><div class="pendulum-bob"></div></div></div></div>
        <div class="logo-text"><span class="brand-name"><span class="brand-initial">P</span>hysics <span class="brand-accent">for Noobs</span></span><span class="brand-tag">FREE THERAPY FOR PHYSICS TRAUMA</span></div>
      </a>
      <div class="nav-links">
        <div class="nav-item">
          <a href="../index.html" class="nav-link">Home</a>
        </div>
        <div class="nav-item">
          <a href="../about.html" class="nav-link">About Me</a>
        </div>
        <div class="nav-item"><a href="#" class="nav-link">Chapters</a><div class="dropdown"><a href="../chapters.html"><div class="dd-icon">&#128214;</div> Theory</a><a href="../slides.html"><div class="dd-icon">&#127916;</div> Slides</a></div></div>        <div class="nav-item">
          <a href="../simulations.html" class="nav-link active">Simulations</a>
        </div>
        <div class="nav-item">
          <a href="../tests.html" class="nav-link">Tests</a>
        </div>
        <div class="nav-item">
          <a href="../flashcards.html" class="nav-link">Flashcards</a>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
        <button class="auth-btn" id="auth-login-btn"><svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Sign in</button>
        <a href="progress.html" class="mobile-auth-action" id="mobile-progress-btn" style="display:none;">Progress</a>
        <button class="mobile-auth-action mobile-signout-btn" id="mobile-signout-btn" style="display:none;">Sign Out</button>

        <div class="user-menu nav-item" id="auth-user-menu" style="display:none;"><img class="user-avatar" id="auth-user-avatar" src="" alt="User"><span class="user-rank-badge rank-bronze" id="auth-rank-badge"><span class="rank-icon" id="auth-rank-icon"></span><span id="auth-rank-label"></span></span><div class="dropdown"><div class="dropdown-rank" id="dropdown-rank-display"><span class="rank-tier" id="dropdown-rank-tier"></span><div class="rank-progress-bar"><div class="rank-progress-fill" id="dropdown-rank-fill"></div></div></div><a href="../progress.html"><div class="dd-icon">&#128200;</div> My Progress</a><div class="dropdown-divider"></div><a href="#" id="auth-logout-btn"><div class="dd-icon">&#128682;</div> Sign Out</a></div></div>
      </div>
      <button class="nav-toggle" aria-label="Menu"><span></span><span></span><span></span></button>
    </div>
  </nav>
  <script>
    (function(){
      var s=document.getElementById('splash');
      if(sessionStorage.getItem('ae-splash')){s.style.display='none';}
      else{
        sessionStorage.setItem('ae-splash','1');setTimeout(function(){s.classList.add('fade-out');},2200);setTimeout(function(){s.style.display='none';},2700);
      }
    })();
  </script>

  <style>
    .bg-grid { display: none !important; }

    .sim-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 24px 40px;
    }

    .sim-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .sim-header h1 {
      font-family: var(--font-display);
      font-size: clamp(1.4rem, 2vw, 1.8rem);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }

    .sim-btn {
      padding: 8px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: var(--font-body);
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .sim-btn:hover {
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.3);
      background: rgba(124, 58, 237, 0.08);
    }

    .sim-btn.primary {
      background: rgba(124, 58, 237, 0.15);
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.3);
    }

    .sim-btn.primary:hover {
      background: rgba(124, 58, 237, 0.25);
    }

    .sim-btn.active {
      background: rgba(124, 58, 237, 0.18);
      color: var(--text-primary);
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 0 10px rgba(124,58,237,0.25);
      transform: scale(1.06);
    }

    .sim-main-row {
      display: flex;
      gap: 1px;
      background: var(--border-subtle);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      overflow: hidden;
    }

    .canvas-wrap {
      flex: 1;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .canvas-wrap canvas {
      display: block;
      width: 100%;
    }

    /* Side Data Panel */
    .side-data {
      width: 320px;
      min-width: 280px;
      background: var(--bg-card);
      padding: 14px;
      display: flex;
      flex-direction: column;
    }

    .side-data h3 {
      font-family: var(--font-display);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .data-grid {
      display: flex;
      flex-direction: column;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-family: var(--font-body);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .data-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-primary);
      font-weight: 600;
      text-align: right;
    }

    .data-value.force-val { color: #ffcc00; }
    .data-value.repulsive { color: #ff5a92; }
    .data-value.attractive { color: #00d4ff; }
    .data-value.positive { color: #ff5a92; }
    .data-value.negative { color: #00d4ff; }

    .data-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 6px 8px;
      margin-top: 8px;
      line-height: 1.5;
      word-break: break-all;
    }

    .data-formula .hl {
      color: #ffcc00;
      font-weight: 700;
    }

    .plot-label {
      font-family: var(--font-display);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .plot-wrap {
      flex: 1;
      min-height: 120px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--bg-secondary);
      display: flex;
    }

    .plot-wrap canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* Controls */
    .controls-bar {
      display: flex;
      align-items: center;
      gap: clamp(10px, 2.5vw, 24px);
      padding: 18px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-top: none;
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-family: var(--font-body);
      font-size: clamp(0.8rem, 0.95vw, 0.95rem);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .control-sep {
      width: 1px;
      height: 24px;
      background: var(--border-subtle);
    }

    .sim-select {
      padding: 7px 28px 7px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: var(--font-body);
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237c3aed'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px 6px;
    }

    .sim-select:hover {
      border-color: rgba(124, 58, 237, 0.3);
      background-color: rgba(124, 58, 237, 0.08);
    }

    .sim-select:focus {
      outline: none;
      border-color: rgba(124, 58, 237, 0.5);
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.15);
    }

    .sign-btn {
      min-width: 36px;
      height: 32px;
      padding: 4px 10px;
      font-size: 0.9rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      border-radius: var(--radius-sm);
      border: 1px solid;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .sign-btn.pos {
      background: rgba(255,45,117,0.18);
      border-color: rgba(255,45,117,0.4);
      color: #ff5a92;
    }

    .sign-btn.neg {
      background: rgba(0,212,255,0.10);
      border-color: rgba(0,212,255,0.3);
      color: #00d4ff;
    }

    .sign-btn:hover {
      transform: scale(1.08);
    }

    .charge-ctrl {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 2px 4px;
    }

    .mag-stepper {
      display: inline-flex;
      align-items: center;
      gap: 0;
    }

    .mag-btn {
      width: 20px;
      height: 24px;
      font-size: 0.7rem;
      font-weight: 700;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      line-height: 1;
      transition: var(--transition-fast);
    }

    .mag-btn:hover {
      color: var(--text-primary);
    }

    .mag-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.78rem;
      font-weight: 600;
      min-width: 14px;
      text-align: center;
      color: var(--text-primary);
    }

    /* Equations */
    .equations-section {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-top: 16px;
    }

    .equations-section h3 {
      font-family: var(--font-display);
      font-size: clamp(0.8rem, 1vw, 1rem);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 14px;
    }

    .equations-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 32px;
    }

    .equation-item {
      font-family: var(--font-body);
      font-size: clamp(1rem, 1.2vw, 1.2rem);
      color: var(--text-primary);
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      white-space: nowrap;
    }

    .equation-item .eq-label {
      color: var(--text-muted);
      font-size: clamp(0.8rem, 0.9vw, 0.9rem);
      display: block;
      margin-bottom: 2px;
    }

    /* Q&A */
    .qa-section {
      margin-top: 32px;
    }

    .qa-section h2 {
      font-family: var(--font-display);
      font-size: clamp(0.9rem, 1.1vw, 1.1rem);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .qa-item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      overflow: hidden;
      transition: var(--transition-fast);
    }

    .qa-item:hover {
      border-color: rgba(124, 58, 237, 0.2);
    }

    .qa-q {
      padding: 16px 24px;
      font-family: var(--font-body);
      font-size: clamp(0.95rem, 1.1vw, 1.15rem);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-fast);
    }

    .qa-q:hover {
      background: var(--bg-glass-hover);
    }

    .qa-q::after {
      content: '+';
      font-size: 1.4rem;
      color: var(--color-primary);
      transition: transform 0.2s;
      font-weight: 300;
    }

    .qa-item.open .qa-q::after {
      content: '\2212';
    }

    .qa-a {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .qa-item.open .qa-a {
      max-height: 500px;
    }

    .qa-a-inner {
      padding: 0 24px 18px;
      font-family: var(--font-body);
      font-size: clamp(0.92rem, 1vw, 1.08rem);
      color: var(--text-secondary);
      line-height: 1.75;
    }

    /* Fullscreen */
    #simArea {
      background: var(--bg-primary);
      position: relative;
    }

    #simArea:fullscreen,
    #simArea:-webkit-full-screen {
      background: var(--bg-primary);
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #simArea:fullscreen .sim-main-row,
    #simArea:-webkit-full-screen .sim-main-row {
      flex: 1;
      min-height: 0;
    }

    #simArea:fullscreen .canvas-wrap,
    #simArea:-webkit-full-screen .canvas-wrap {
      flex: 1;
      min-height: 0;
    }

    #simArea:fullscreen .controls-bar,
    #simArea:-webkit-full-screen .controls-bar {
      border-radius: 0;
    }

    @media (max-width: 900px) {
      .sim-main-row { flex-direction: column; }
      .side-data { width: 100%; min-width: unset; }
    }

    @media (max-width: 768px) {
      .sim-wrapper { padding: 70px 12px 24px; }
      .sim-header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .controls-bar { gap: 8px; padding: 12px; }
    }

    /* === Tutorial Overlay === */
    .sim-tutorial {
      position: absolute;
      inset: 0;
      z-index: 50;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(0.5px);
      -webkit-backdrop-filter: blur(0.5px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease;
      cursor: pointer;
      border-radius: var(--radius-md);
    }

    .tut-hint {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      font-size: 0.88rem;
      pointer-events: none;
    }

    .tut-arrows-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .tut-label {
      font-family: var(--font-body);
      background: rgba(255,255,255,0.92);
      color: #1a1a2e;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.82rem;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }

    .tut-dismiss {
      position: absolute;
      bottom: 38%;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 32px;
      font-family: var(--font-body);
      font-size: 0.95rem;
      font-weight: 700;
      color: #1a1a2e;
      background: #fff;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 4px 16px rgba(124,58,237,0.3);
      transition: background 0.2s, transform 0.2s;
    }

    .tut-dismiss:hover {
      background: #e8e0f8;
      transform: translateX(-50%) scale(1.04);
    }

    @media (max-width: 900px) {
      .sim-tutorial { display: none !important; }
      #helpBtn { display: none; }
    }
  </style>

  <div class="sim-wrapper">
    <div id="simArea">
    <div class="sim-header">
      <h1>Electrostatic Potential</h1>
      <div style="display:flex;gap:8px;">
        <button class="sim-btn" id="fieldLinesBtn">Field Lines</button>
        <button class="sim-btn" id="resetBtn">Reset</button>
        <button class="sim-btn" id="fullscreenBtn">Full Screen</button>
        <button class="sim-btn" id="helpBtn">? Help</button>
      </div>
    </div>

    <div class="sim-main-row">
      <div class="canvas-wrap">
        <canvas id="simCanvas"></canvas>
      </div>
      <div class="side-data">
        <h3>Data</h3>
        <div class="data-grid">
          <div class="data-row">
            <span class="data-label">V</span>
            <span class="data-value force-val" id="dataForce">&mdash;</span>
          </div>
          <div class="data-row">
            <span class="data-label">r</span>
            <span class="data-value" id="dataDist">&mdash;</span>
          </div>
          <div class="data-row">
            <span class="data-label">Sign</span>
            <span class="data-value" id="dataType">&mdash;</span>
          </div>
          <div class="data-row">
            <span class="data-label">E</span>
            <span class="data-value" id="dataField">&mdash;</span>
          </div>
        </div>
        <div class="data-formula" id="dataSubstitution">&mdash;</div>
        <div class="plot-label">V vs r</div>
        <div class="plot-wrap">
          <canvas id="plotCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="controls-bar">
      <div class="control-group" id="q1Ctrl">
        <label>Q&#8321;:</label>
        <!-- Populated by JS -->
      </div>

      <div class="control-sep"></div>

      <div class="control-group">
        <label>Medium:</label>
        <select class="sim-select" id="mediumSelect">
          <option value="1">Vacuum</option>
          <option value="80">Water</option>
          <option value="5">Glass</option>
          <option value="6">Mica</option>
        </select>
      </div>

      <div class="control-sep"></div>

      <button class="sim-btn" id="resetArrangement">&#8635; Reset</button>
    </div>

    <!-- Tutorial Overlay -->
    <div class="sim-tutorial" id="simTutorial" style="display:none;">
      <svg class="tut-arrows-svg" id="tutArrowsSvg"></svg>

      <div class="tut-hint" id="tutHintCharges">
        <div class="tut-label">Adjust source charge sign &amp; magnitude</div>
      </div>
      <div class="tut-hint" id="tutHintDrag">
        <div class="tut-label">Drag the test point to measure potential at different positions</div>
      </div>
      <div class="tut-hint" id="tutHintMedium">
        <div class="tut-label">Change the dielectric medium</div>
      </div>

      <button class="tut-dismiss">Got it, let's start!</button>
    </div>

    </div><!-- end #simArea -->

    <div class="equations-section">
      <h3>Key Equations</h3>
      <div class="equations-grid">
        <div class="equation-item">
          <span class="eq-label">Electric Potential</span>
          V = kq/r
        </div>
        <div class="equation-item">
          <span class="eq-label">With Dielectric</span>
          V = kq/(&kappa;r)
        </div>
        <div class="equation-item">
          <span class="eq-label">Coulomb Constant</span>
          k = 9 &times; 10&sup9; N&middot;m&sup2;/C&sup2;
        </div>
        <div class="equation-item">
          <span class="eq-label">Field-Potential Relation</span>
          E = &minus;dV/dr
        </div>
      </div>
    </div>

    <div class="qa-section">
      <h2>Test Your Understanding</h2>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is electrostatic potential?</div>
        <div class="qa-a"><div class="qa-a-inner">
          Electrostatic potential V at a point is the <strong>work done per unit positive charge</strong> in bringing a small test charge from infinity to that point. V = kq/r where k = 9 &times; 10&sup9; N&middot;m&sup2;/C&sup2; is Coulomb's constant, q is the source charge, and r is the distance. It is a <strong>scalar quantity</strong>, meaning it has magnitude but no direction.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">How does potential change with distance?</div>
        <div class="qa-a"><div class="qa-a-inner">
          Potential follows an <strong>inverse relationship</strong> (V &prop; 1/r). As you move away from a positive charge, potential decreases. As you move away from a negative charge, potential increases (becomes less negative). This 1/r dependence is <strong>slower than the 1/r&sup2; falloff</strong> of force, meaning potential has a longer range of influence than the Coulomb force.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">Why does potential decrease in the direction of the electric field?</div>
        <div class="qa-a"><div class="qa-a-inner">
          The electric field E = &minus;dV/dr always points from <strong>higher to lower potential</strong>. For a positive charge, the field points radially outward, so potential decreases outward. This means work must be done against the field to move a positive test charge toward a positive source charge (to higher potential). The electric field is essentially the negative gradient of the potential.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">How does the medium affect electrostatic potential?</div>
        <div class="qa-a"><div class="qa-a-inner">
          A dielectric medium <strong>reduces the potential by a factor of &kappa;</strong> (the dielectric constant). V = kq/(&kappa;r). In water (&kappa; &asymp; 80), the potential is 80 times weaker than in vacuum. This is because the dielectric partially <strong>shields the charge</strong> by aligning its polar molecules in opposition to the field, effectively reducing the net charge seen by distant points.
        </div></div>
      </div>

      <div class="qa-item">
        <div class="qa-q" onclick="this.parentElement.classList.toggle('open')">What is the difference between electric potential and potential energy?</div>
        <div class="qa-a"><div class="qa-a-inner">
          <strong>Electric potential V</strong> is a property of the field at a point (measured in Volts = Joules/Coulomb). <strong>Electric potential energy U = qV</strong> is the energy of a specific charge q placed at that point (measured in Joules). Potential is potential energy per unit charge &mdash; it describes what the field can do, while potential energy describes the actual stored energy for a given charge placed there.
        </div></div>
      </div>
    </div>
  </div>

  <script>
    // === THEME COLORS ===
    var tc = {};
    function updateThemeColors() {
      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      tc = {
        bg: isLight ? '#e8eaf0' : '#080818',
        bgCenter: isLight ? '#f0f2f8' : '#0a0a24',
        grid: isLight ? 'rgba(0,120,200,0.06)' : 'rgba(0,212,255,0.04)',
        text: isLight ? '#333' : '#fff',
        labelBg: isLight ? 'rgba(255,255,255,0.88)' : 'rgba(10,10,30,0.88)',
        labelBorder: isLight ? 'rgba(124,58,237,0.35)' : 'rgba(124,58,237,0.35)',
        labelText: isLight ? '#7c3aed' : '#a78bfa'
      };
    }
    updateThemeColors();
    new MutationObserver(function() { updateThemeColors(); draw(); })
      .observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    // === CANVAS SETUP ===
    var canvas = document.getElementById('simCanvas');
    var ctx = canvas.getContext('2d');
    var canvasW, canvasH;

    function resizeCanvas() {
      var wrap = canvas.parentElement;
      var isFS = !!document.fullscreenElement;
      var w = wrap.clientWidth;
      var h = isFS ? wrap.clientHeight : Math.max(350, window.innerHeight - 300);
      var dpr = window.devicePixelRatio || 1;

      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      canvasW = w;
      canvasH = h;

      resetPositions();
    }

    window.addEventListener('resize', function() {
      resizeCanvas();
      resizePlotCanvas();
    });

    // === SIMULATION STATE ===
    var CHARGE_RADIUS = 14;
    var PIXELS_PER_METER = 200;
    var K_COULOMB = 9e9;
    var MAX_MAG = 5;
    var GRAB_RADIUS = 22;
    var PROBE_RADIUS = 8;

    var q1 = { x: 0, y: 0, sign: 1, mag: 1 }; // SOURCE charge
    var q2 = { x: 0, y: 0 };                   // TEST POINT (no sign/mag)
    var kappa = 1;
    var draggingQ2 = false;
    var glowPhase = 0;
    var showFieldLines = false;

    // Achievement tracking
    var _achPotentialZero = false;
    var _achHighPotential = false;
    var _achMediumEffect = false;
    var initialKappa = 1;

    function resetPositions() {
      var cy = canvasH / 2;
      q1.x = canvasW * 0.35;
      q1.y = cy;
      q2.x = canvasW * 0.65;
      q2.y = cy;
    }

    function resetAll() {
      q1.sign = 1; q1.mag = 1;
      kappa = 1;
      initialKappa = 1;
      document.getElementById('mediumSelect').value = '1';
      potentialHistory = [];
      resetPositions();
      buildChargeControls();
    }

    // === CHARGE CONTROLS (Q1 only) ===
    function buildChargeControls() {
      buildOneChargeCtrl('q1Ctrl', q1, 'Q\u2081');
    }

    function buildOneChargeCtrl(containerId, charge, label) {
      var container = document.getElementById(containerId);
      var ctrls = container.querySelectorAll('.charge-ctrl');
      for (var i = 0; i < ctrls.length; i++) ctrls[i].remove();

      var wrap = document.createElement('div');
      wrap.className = 'charge-ctrl';

      // Sign toggle button
      var btn = document.createElement('button');
      function updateBtn() {
        var sign = charge.sign > 0 ? '+' : '\u2212';
        btn.textContent = label + ' ' + sign;
        btn.className = 'sign-btn ' + (charge.sign > 0 ? 'pos' : 'neg');
      }
      updateBtn();
      btn.addEventListener('click', function() {
        charge.sign *= -1;
        updateBtn();
      });

      // Magnitude stepper
      var stepper = document.createElement('div');
      stepper.className = 'mag-stepper';
      var downBtn = document.createElement('button');
      downBtn.className = 'mag-btn';
      downBtn.textContent = '\u25BC';
      var magVal = document.createElement('span');
      magVal.className = 'mag-val';
      magVal.textContent = charge.mag;
      var upBtn = document.createElement('button');
      upBtn.className = 'mag-btn';
      upBtn.textContent = '\u25B2';

      downBtn.addEventListener('click', function() {
        if (charge.mag > 1) {
          charge.mag--;
          magVal.textContent = charge.mag;
        }
      });
      upBtn.addEventListener('click', function() {
        if (charge.mag < MAX_MAG) {
          charge.mag++;
          magVal.textContent = charge.mag;
        }
      });

      stepper.appendChild(downBtn);
      stepper.appendChild(magVal);
      stepper.appendChild(upBtn);

      wrap.appendChild(btn);
      wrap.appendChild(stepper);
      container.appendChild(wrap);
    }

    // === MEDIUM DROPDOWN ===
    var mediumSelect = document.getElementById('mediumSelect');
    mediumSelect.addEventListener('change', function() {
      kappa = parseFloat(mediumSelect.value);
      if (kappa !== initialKappa && kappa !== 1) {
        _achMediumEffect = true;
      }
    });

    // === RESET BUTTONS ===
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('resetArrangement').addEventListener('click', resetAll);

    // === PHYSICS ===
    function getDistPx() {
      var dx = q2.x - q1.x;
      var dy = q2.y - q1.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function getRealPotential() {
      var rPx = getDistPx();
      var rMeters = rPx / PIXELS_PER_METER;
      if (rMeters < 0.01) rMeters = 0.01;
      var charge = q1.sign * q1.mag * 1e-6; // microcoulombs
      return K_COULOMB * charge / (kappa * rMeters);
    }

    function getRealField() {
      var rPx = getDistPx();
      var rMeters = rPx / PIXELS_PER_METER;
      if (rMeters < 0.01) rMeters = 0.01;
      var charge = q1.mag * 1e-6;
      return K_COULOMB * charge / (kappa * rMeters * rMeters);
    }

    function formatPotential(v) {
      var abs = Math.abs(v);
      if (abs >= 1000) return (v / 1000).toFixed(2) + ' kV';
      if (abs >= 1) return v.toFixed(2) + ' V';
      if (abs >= 0.001) return (v * 1000).toFixed(2) + ' mV';
      return (v * 1e6).toFixed(2) + ' \u00B5V';
    }

    function getPotentialUnit(v) {
      var abs = Math.abs(v);
      if (abs >= 1000) return { val: v / 1000, unit: 'kV', scale: 0.001 };
      if (abs >= 1) return { val: v, unit: 'V', scale: 1 };
      if (abs >= 0.001) return { val: v * 1000, unit: 'mV', scale: 1000 };
      return { val: v * 1e6, unit: '\u00B5V', scale: 1e6 };
    }

    function formatField(e) {
      var abs = Math.abs(e);
      if (abs >= 1e6) return (e / 1e6).toFixed(2) + ' MV/m';
      if (abs >= 1e3) return (e / 1e3).toFixed(2) + ' kV/m';
      if (abs >= 1) return e.toFixed(2) + ' V/m';
      return (e * 1000).toFixed(2) + ' mV/m';
    }

    function getMediumName() {
      var v = mediumSelect.value;
      if (v === '1') return 'Vacuum';
      if (v === '80') return 'Water';
      if (v === '5') return 'Glass';
      if (v === '6') return 'Mica';
      return 'Unknown';
    }

    // === DRAWING ===
    function drawBackground() {
      var grad = ctx.createRadialGradient(canvasW / 2, canvasH / 2, 0, canvasW / 2, canvasH / 2, canvasW * 0.7);
      grad.addColorStop(0, tc.bgCenter);
      grad.addColorStop(1, tc.bg);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvasW, canvasH);

      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      var gridColor = isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.035)';
      ctx.strokeStyle = gridColor;
      ctx.lineWidth = 1;
      for (var x = 40; x < canvasW; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvasH);
        ctx.stroke();
      }
      for (var y = 40; y < canvasH; y += 40) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvasW, y);
        ctx.stroke();
      }
    }

    function drawMediumOverlay() {
      if (kappa <= 1) return;
      var tints = {
        80: 'rgba(0,100,200,0.06)',
        5:  'rgba(200,180,100,0.05)',
        6:  'rgba(180,120,200,0.05)'
      };
      var tint = tints[kappa] || 'rgba(100,100,200,0.04)';
      ctx.fillStyle = tint;
      ctx.fillRect(0, 0, canvasW, canvasH);
    }

    function drawPotentialGradient() {
      // Radial gradient centered on Q1 indicating potential landscape
      var maxR = Math.sqrt(canvasW * canvasW + canvasH * canvasH);
      var grad = ctx.createRadialGradient(q1.x, q1.y, CHARGE_RADIUS + 2, q1.x, q1.y, maxR * 0.75);

      if (q1.sign > 0) {
        // Positive charge: warm (red/orange) near, cool (blue) far
        grad.addColorStop(0,   'rgba(255,80,80,0.14)');
        grad.addColorStop(0.3, 'rgba(255,140,60,0.09)');
        grad.addColorStop(0.6, 'rgba(100,100,255,0.06)');
        grad.addColorStop(1,   'rgba(0,100,200,0.08)');
      } else {
        // Negative charge: cool (blue) near, warm far
        grad.addColorStop(0,   'rgba(0,180,255,0.14)');
        grad.addColorStop(0.3, 'rgba(60,80,200,0.09)');
        grad.addColorStop(0.6, 'rgba(200,80,80,0.06)');
        grad.addColorStop(1,   'rgba(255,100,60,0.08)');
      }

      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvasW, canvasH);
    }

    function drawEquipotentialCircles() {
      // Draw 3 concentric dashed equipotential circles around Q1
      var edgeDist = Math.min(
        Math.sqrt(Math.pow(q1.x, 2) + Math.pow(q1.y, 2)),
        Math.sqrt(Math.pow(canvasW - q1.x, 2) + Math.pow(q1.y, 2)),
        Math.sqrt(Math.pow(q1.x, 2) + Math.pow(canvasH - q1.y, 2)),
        Math.sqrt(Math.pow(canvasW - q1.x, 2) + Math.pow(canvasH - q1.y, 2))
      );

      var fractions = [0.3, 0.5, 0.7];
      ctx.save();
      ctx.setLineDash([5, 6]);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(160,100,255,0.45)';

      for (var fi = 0; fi < fractions.length; fi++) {
        var r = edgeDist * fractions[fi];
        if (r < CHARGE_RADIUS + 4) continue;

        ctx.beginPath();
        ctx.arc(q1.x, q1.y, r, 0, Math.PI * 2);
        ctx.stroke();

        // Label this circle with its V value
        var rM = r / PIXELS_PER_METER;
        if (rM < 0.01) rM = 0.01;
        var charge = q1.sign * q1.mag * 1e-6;
        var v = K_COULOMB * charge / (kappa * rM);
        var vStr = formatPotential(v);

        ctx.setLineDash([]);
        ctx.font = '600 10px "Inter", sans-serif';
        var labelX = q1.x + r * 0.707;
        var labelY = q1.y - r * 0.707;
        var tw = ctx.measureText(vStr).width;
        ctx.fillStyle = 'rgba(10,10,30,0.72)';
        ctx.fillRect(labelX - 2, labelY - 9, tw + 6, 14);
        ctx.fillStyle = 'rgba(180,130,255,0.9)';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(vStr, labelX + 1, labelY - 2);
        ctx.setLineDash([5, 6]);
      }

      ctx.restore();
    }

    function drawDistanceLine() {
      var dx = q2.x - q1.x;
      var dy = q2.y - q1.y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      var rMeters = dist / PIXELS_PER_METER;

      // Dashed line
      ctx.save();
      ctx.setLineDash([6, 4]);
      ctx.beginPath();
      ctx.moveTo(q1.x, q1.y);
      ctx.lineTo(q2.x, q2.y);
      ctx.strokeStyle = 'rgba(180,120,255,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();

      // Midpoint pill label
      var midX = (q1.x + q2.x) / 2;
      var midY = (q1.y + q2.y) / 2;
      var text = 'r = ' + rMeters.toFixed(2) + ' m';
      ctx.font = 'bold 12px "Inter", sans-serif';
      var tw = ctx.measureText(text).width;
      var pillW = tw + 16;
      var pillH = 24;

      ctx.fillStyle = tc.labelBg;
      ctx.beginPath();
      ctx.roundRect(midX - pillW / 2, midY - pillH / 2 - 14, pillW, pillH, 12);
      ctx.fill();
      ctx.strokeStyle = 'rgba(180,120,255,0.4)';
      ctx.lineWidth = 1;
      ctx.stroke();

      ctx.fillStyle = tc.labelText;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, midX, midY - 14);
    }

    function drawElectricFieldDirection() {
      var dx = q2.x - q1.x;
      var dy = q2.y - q1.y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 1) return;

      var nx = dx / dist;
      var ny = dy / dist;

      // For +Q: E points away from Q1 (from Q1 toward Q2 direction)
      // For -Q: E points toward Q1 (from Q2 toward Q1 direction)
      var arrowLen = 55;
      var startR = CHARGE_RADIUS + 8;

      var dirX, dirY, startX, startY, endX, endY;
      if (q1.sign > 0) {
        dirX = nx; dirY = ny;
        startX = q1.x + nx * startR;
        startY = q1.y + ny * startR;
      } else {
        dirX = -nx; dirY = -ny;
        startX = q1.x - nx * startR;
        startY = q1.y - ny * startR;
      }
      endX = startX + dirX * arrowLen;
      endY = startY + dirY * arrowLen;

      // Arrow shaft
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.strokeStyle = 'rgba(255,200,50,0.75)';
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Arrowhead
      var headLen = 9;
      var angle = Math.atan2(dirY, dirX);
      ctx.beginPath();
      ctx.moveTo(endX, endY);
      ctx.lineTo(endX - headLen * Math.cos(angle - 0.4), endY - headLen * Math.sin(angle - 0.4));
      ctx.lineTo(endX - headLen * Math.cos(angle + 0.4), endY - headLen * Math.sin(angle + 0.4));
      ctx.closePath();
      ctx.fillStyle = 'rgba(255,200,50,0.85)';
      ctx.fill();

      // Label "V decreases â†’"
      var labelMidX = startX + dirX * (arrowLen / 2);
      var labelMidY = startY + dirY * (arrowLen / 2);
      // Offset label perpendicular to arrow
      var perpX = -dirY;
      var perpY = dirX;
      var labelX = labelMidX + perpX * 16;
      var labelY = labelMidY + perpY * 16;

      ctx.font = '600 10px "Inter", sans-serif';
      var labelText = 'V decreases \u2192';
      var tw = ctx.measureText(labelText).width;
      ctx.fillStyle = 'rgba(10,10,30,0.72)';
      ctx.fillRect(labelX - tw / 2 - 3, labelY - 8, tw + 6, 14);
      ctx.fillStyle = 'rgba(255,200,50,0.95)';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(labelText, labelX, labelY);

      ctx.restore();
    }

    function drawPotentialLabel() {
      var v = getRealPotential();
      var pu = getPotentialUnit(v);
      var signStr = q1.sign > 0 ? '(+)' : '(-)';
      var text = 'V = ' + pu.val.toFixed(2) + ' ' + pu.unit + ' ' + signStr;

      ctx.font = 'bold 13px "Inter", sans-serif';
      var tw = ctx.measureText(text).width;
      var pillW = tw + 24;
      var pillH = 28;
      var pillX = canvasW / 2 - pillW / 2;
      var pillY = 20;

      ctx.fillStyle = tc.labelBg;
      ctx.beginPath();
      ctx.roundRect(pillX, pillY, pillW, pillH, 14);
      ctx.fill();
      ctx.strokeStyle = q1.sign > 0 ? 'rgba(255,90,146,0.5)' : 'rgba(0,212,255,0.5)';
      ctx.lineWidth = 1.5;
      ctx.stroke();

      ctx.fillStyle = q1.sign > 0 ? 'rgba(255,90,146,0.95)' : 'rgba(0,212,255,0.95)';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, canvasW / 2, pillY + pillH / 2);
    }

    function drawCharge(q) {
      var pulse = 0.5 + 0.5 * Math.sin(glowPhase);
      var r = CHARGE_RADIUS + (q.mag - 1) * 3;
      var glowRadius = (28 + (q.mag - 1) * 6) + 10 * pulse;
      var glowAlpha = 0.2 + 0.15 * pulse;
      var isPos = q.sign > 0;

      // Glow
      var glowGrad = ctx.createRadialGradient(q.x, q.y, 0, q.x, q.y, glowRadius);
      if (isPos) {
        glowGrad.addColorStop(0, 'rgba(255,45,117,' + glowAlpha + ')');
        glowGrad.addColorStop(0.6, 'rgba(255,45,117,' + (glowAlpha * 0.4) + ')');
        glowGrad.addColorStop(1, 'rgba(255,45,117,0)');
      } else {
        glowGrad.addColorStop(0, 'rgba(0,212,255,' + glowAlpha + ')');
        glowGrad.addColorStop(0.6, 'rgba(0,212,255,' + (glowAlpha * 0.4) + ')');
        glowGrad.addColorStop(1, 'rgba(0,212,255,0)');
      }
      ctx.beginPath();
      ctx.arc(q.x, q.y, glowRadius, 0, Math.PI * 2);
      ctx.fillStyle = glowGrad;
      ctx.fill();

      // Charge body
      ctx.beginPath();
      ctx.arc(q.x, q.y, r, 0, Math.PI * 2);
      var grad = ctx.createRadialGradient(q.x - 3, q.y - 3, 0, q.x, q.y, r);
      if (isPos) {
        grad.addColorStop(0, '#ff5a92');
        grad.addColorStop(1, '#ff2d75');
      } else {
        grad.addColorStop(0, '#33e0ff');
        grad.addColorStop(1, '#00d4ff');
      }
      ctx.fillStyle = grad;
      ctx.shadowColor = isPos ? '#ff2d75' : '#00d4ff';
      ctx.shadowBlur = 12 + 6 * pulse;
      ctx.fill();
      ctx.shadowBlur = 0;

      // Magnitude label inside charge
      ctx.fillStyle = '#fff';
      ctx.font = 'bold ' + (12 + q.mag) + 'px "JetBrains Mono", monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      var sign = q.sign > 0 ? '+' : '\u2212';
      ctx.fillText(sign + q.mag, q.x, q.y);

      // Label below charge
      ctx.font = 'bold 11px "Inter", sans-serif';
      ctx.fillStyle = tc.labelText;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('Q\u2081 (SOURCE)', q.x, q.y + r + 6);
    }

    function drawTestPoint(q) {
      var pulse = 0.5 + 0.5 * Math.sin(glowPhase * 1.3);
      var r = PROBE_RADIUS;
      var glowAlpha = 0.15 + 0.1 * pulse;

      // Subtle glow
      var glowGrad = ctx.createRadialGradient(q.x, q.y, 0, q.x, q.y, r * 3.5);
      glowGrad.addColorStop(0, 'rgba(220,220,255,' + (glowAlpha * 1.5) + ')');
      glowGrad.addColorStop(1, 'rgba(220,220,255,0)');
      ctx.beginPath();
      ctx.arc(q.x, q.y, r * 3.5, 0, Math.PI * 2);
      ctx.fillStyle = glowGrad;
      ctx.fill();

      // Circle
      ctx.beginPath();
      ctx.arc(q.x, q.y, r, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(230,230,255,0.9)';
      ctx.lineWidth = 1.5;
      ctx.shadowColor = 'rgba(180,160,255,0.8)';
      ctx.shadowBlur = 8 + 4 * pulse;
      ctx.stroke();
      ctx.shadowBlur = 0;

      // Crosshair
      var crossLen = r + 5;
      ctx.beginPath();
      ctx.moveTo(q.x - crossLen, q.y);
      ctx.lineTo(q.x + crossLen, q.y);
      ctx.moveTo(q.x, q.y - crossLen);
      ctx.lineTo(q.x, q.y + crossLen);
      ctx.strokeStyle = 'rgba(220,210,255,0.75)';
      ctx.lineWidth = 1;
      ctx.stroke();

      // Label below
      ctx.font = 'bold 10px "Inter", sans-serif';
      ctx.fillStyle = tc.labelText;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('Test Point', q.x, q.y + r + 5);
    }

    function drawMediumLabel() {
      if (kappa <= 1) return;
      var name = getMediumName();
      var text = name + ' (\u03BA=' + kappa + ')';

      ctx.font = '600 11px "Inter", sans-serif';
      var tw = ctx.measureText(text).width;
      var pillW = tw + 14;
      var pillH = 22;
      var pillX = canvasW - pillW - 12;
      var pillY = canvasH - pillH - 12;

      ctx.fillStyle = tc.labelBg;
      ctx.beginPath();
      ctx.roundRect(pillX, pillY, pillW, pillH, 11);
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,150,255,0.3)';
      ctx.lineWidth = 1;
      ctx.stroke();

      ctx.fillStyle = tc.labelText;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, pillX + pillW / 2, pillY + pillH / 2);
    }

    // === PLOT CANVAS & DATA PANEL ===
    var plotCanvas = document.getElementById('plotCanvas');
    var pctx = plotCanvas.getContext('2d');
    var potentialHistory = []; // [{r: meters, v: volts}]
    var MAX_HISTORY = 60;

    function resizePlotCanvas() {
      var wrap = plotCanvas.parentElement;
      var w = wrap.clientWidth;
      var h = wrap.clientHeight || 160;
      var dpr = window.devicePixelRatio || 1;
      plotCanvas.width = w * dpr;
      plotCanvas.height = h * dpr;
      plotCanvas.style.width = w + 'px';
      plotCanvas.style.height = h + 'px';
      pctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function recordPotentialPoint() {
      var rPx = getDistPx();
      var rMeters = rPx / PIXELS_PER_METER;
      var v = getRealPotential();
      potentialHistory.push({ r: rMeters, v: Math.abs(v) });
      if (potentialHistory.length > MAX_HISTORY) potentialHistory.shift();
    }

    function drawPlot() {
      var wrap = plotCanvas.parentElement;
      var w = wrap.clientWidth;
      var h = wrap.clientHeight || 160;
      if (plotCanvas.width !== Math.round(w * (window.devicePixelRatio || 1))) resizePlotCanvas();

      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      var bgColor = isLight ? '#f0f2f8' : '#0c0c20';
      var gridColor = isLight ? 'rgba(0,0,0,0.06)' : 'rgba(255,255,255,0.06)';
      var axisColor = isLight ? 'rgba(0,0,0,0.25)' : 'rgba(255,255,255,0.2)';
      var textColor = isLight ? '#666' : '#888';
      var curveColor = '#a78bfa';
      var dotColor = q1.sign > 0 ? '#ff5a92' : '#00d4ff';

      pctx.fillStyle = bgColor;
      pctx.fillRect(0, 0, w, h);

      var pad = { left: 36, right: 12, top: 16, bottom: 24 };
      var pw = w - pad.left - pad.right;
      var ph = h - pad.top - pad.bottom;

      var rMeters = getDistPx() / PIXELS_PER_METER;
      var currentV = Math.abs(getRealPotential());
      var pu = getPotentialUnit(getRealPotential());

      var rMin = 0.1;
      var rMax = Math.max(2, rMeters * 1.5);

      // V at rMin for scale
      var chargeAbs = q1.mag * 1e-6;
      var vAtRmin = K_COULOMB * chargeAbs / (kappa * rMin);
      var vMax = vAtRmin * Math.abs(pu.scale);
      if (vMax < 1) vMax = 1;

      // Grid lines
      pctx.strokeStyle = gridColor;
      pctx.lineWidth = 1;
      for (var gi = 1; gi <= 4; gi++) {
        var gy = pad.top + ph * (1 - gi / 4);
        pctx.beginPath();
        pctx.moveTo(pad.left, gy);
        pctx.lineTo(pad.left + pw, gy);
        pctx.stroke();
      }

      // Axes
      pctx.strokeStyle = axisColor;
      pctx.lineWidth = 1.5;
      pctx.beginPath();
      pctx.moveTo(pad.left, pad.top);
      pctx.lineTo(pad.left, pad.top + ph);
      pctx.lineTo(pad.left + pw, pad.top + ph);
      pctx.stroke();

      // Axis labels
      pctx.fillStyle = textColor;
      pctx.font = '600 9px "Inter", sans-serif';
      pctx.textAlign = 'center';
      pctx.textBaseline = 'top';
      pctx.fillText('r (m)', pad.left + pw / 2, h - 10);
      pctx.save();
      pctx.translate(10, pad.top + ph / 2);
      pctx.rotate(-Math.PI / 2);
      pctx.fillText('|V| (' + pu.unit + ')', 0, 0);
      pctx.restore();

      // Theoretical 1/r curve
      pctx.beginPath();
      pctx.strokeStyle = curveColor;
      pctx.lineWidth = 1.5;
      pctx.globalAlpha = 0.5;
      var steps = 80;
      for (var si = 0; si <= steps; si++) {
        var rr = rMin + (rMax - rMin) * si / steps;
        var vv = K_COULOMB * chargeAbs / (kappa * rr) * Math.abs(pu.scale);
        var px = pad.left + (rr - rMin) / (rMax - rMin) * pw;
        var py = pad.top + ph * (1 - Math.min(vv / vMax, 1));
        if (si === 0) pctx.moveTo(px, py);
        else pctx.lineTo(px, py);
      }
      pctx.stroke();
      pctx.globalAlpha = 1;

      // Scatter recorded points
      for (var hi = 0; hi < potentialHistory.length; hi++) {
        var pt = potentialHistory[hi];
        if (pt.r < rMin || pt.r > rMax) continue;
        var ppx = pad.left + (pt.r - rMin) / (rMax - rMin) * pw;
        var vScaled = pt.v * Math.abs(pu.scale);
        var ppy = pad.top + ph * (1 - Math.min(vScaled / vMax, 1));
        var alpha = 0.3 + 0.5 * (hi / potentialHistory.length);
        pctx.beginPath();
        pctx.arc(ppx, ppy, 2.5, 0, Math.PI * 2);
        pctx.fillStyle = q1.sign > 0 ? 'rgba(255,90,146,' + alpha + ')' : 'rgba(0,212,255,' + alpha + ')';
        pctx.fill();
      }

      // Current point (bright)
      var curPx = pad.left + (rMeters - rMin) / (rMax - rMin) * pw;
      var curVScaled = currentV * Math.abs(pu.scale);
      var curPy = pad.top + ph * (1 - Math.min(curVScaled / vMax, 1));
      if (rMeters >= rMin && rMeters <= rMax) {
        pctx.beginPath();
        pctx.arc(curPx, curPy, 4, 0, Math.PI * 2);
        pctx.fillStyle = dotColor;
        pctx.shadowColor = dotColor;
        pctx.shadowBlur = 6;
        pctx.fill();
        pctx.shadowBlur = 0;
      }

      // R-axis tick labels
      pctx.fillStyle = textColor;
      pctx.font = '9px "JetBrains Mono", monospace';
      pctx.textAlign = 'center';
      pctx.textBaseline = 'top';
      var rTicks = [rMin, (rMin + rMax) / 2, rMax];
      for (var ti = 0; ti < rTicks.length; ti++) {
        var tx = pad.left + (rTicks[ti] - rMin) / (rMax - rMin) * pw;
        pctx.fillText(rTicks[ti].toFixed(1), tx, pad.top + ph + 3);
      }

      // V-axis tick labels
      pctx.textAlign = 'right';
      pctx.textBaseline = 'middle';
      var vTicks = [0, vMax / 2, vMax];
      for (var vi = 0; vi < vTicks.length; vi++) {
        var ty = pad.top + ph * (1 - vTicks[vi] / vMax);
        var lbl = vTicks[vi] < 10 ? vTicks[vi].toFixed(1) : Math.round(vTicks[vi]);
        pctx.fillText(lbl, pad.left - 4, ty);
      }
    }

    function updateDataPanel() {
      var rPx = getDistPx();
      var rMeters = rPx / PIXELS_PER_METER;
      document.getElementById('dataDist').textContent = rMeters.toFixed(3) + ' m';

      var v = getRealPotential();
      var pu = getPotentialUnit(v);
      var potStr = formatPotential(v);
      var forceEl = document.getElementById('dataForce');
      forceEl.textContent = potStr;

      var signEl = document.getElementById('dataType');
      if (q1.sign > 0) {
        signEl.textContent = 'Positive';
        signEl.className = 'data-value positive';
      } else {
        signEl.textContent = 'Negative';
        signEl.className = 'data-value negative';
      }

      var e = getRealField();
      document.getElementById('dataField').textContent = formatField(e);

      // Substitution formula
      var sub = document.getElementById('dataSubstitution');
      var signStr = q1.sign > 0 ? '' : '\u2212';
      sub.innerHTML =
        'V = k\u00B7q / ' + (kappa > 1 ? '\u03BA' : '') + 'r' +
        '<br>= 9e9\u00D7' + signStr + q1.mag + '\u00D710\u207B\u2076 / ' +
        (kappa > 1 ? kappa + '\u00D7' : '') + rMeters.toFixed(2) +
        '<br><span class="hl">= ' + potStr + '</span>';
    }

    // === ELECTRIC FIELD LINES ===
    function drawFieldLines() {
      if (!showFieldLines) return;
      var NUM_LINES = 12;
      var maxLen = Math.max(canvasW, canvasH) * 1.2;
      var step = 4;
      var isPos = q1.sign > 0;

      for (var i = 0; i < NUM_LINES; i++) {
        var angle = (i / NUM_LINES) * Math.PI * 2;
        ctx.beginPath();
        var startR = CHARGE_RADIUS + (q1.mag - 1) * 3 + 6;
        var sx = q1.x + Math.cos(angle) * startR;
        var sy = q1.y + Math.sin(angle) * startR;
        ctx.moveTo(sx, sy);

        var px = sx, py = sy;
        var totalLen = 0;
        while (totalLen < maxLen) {
          // For a single point charge, field is purely radial
          var dx = px - q1.x;
          var dy = py - q1.y;
          var r = Math.sqrt(dx * dx + dy * dy);
          if (r < 1) break;
          var nx = dx / r;
          var ny = dy / r;
          // For +Q field points outward, for -Q inward
          if (!isPos) { nx = -nx; ny = -ny; }
          px += nx * step;
          py += ny * step;
          totalLen += step;
          // Stop if out of canvas
          if (px < -20 || px > canvasW + 20 || py < -20 || py > canvasH + 20) break;
          ctx.lineTo(px, py);
        }

        ctx.strokeStyle = 'rgba(255,200,0,0.25)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Arrowhead at 40% along the line
        var arrowR = startR + maxLen * 0.25;
        var ax = q1.x + Math.cos(angle) * arrowR;
        var ay = q1.y + Math.sin(angle) * arrowR;
        if (ax > 0 && ax < canvasW && ay > 0 && ay < canvasH) {
          var adx = isPos ? Math.cos(angle) : -Math.cos(angle);
          var ady = isPos ? Math.sin(angle) : -Math.sin(angle);
          var headLen = 8;
          var a = Math.atan2(ady, adx);
          ctx.beginPath();
          ctx.moveTo(ax + adx * headLen * 0.5, ay + ady * headLen * 0.5);
          ctx.lineTo(ax - headLen * Math.cos(a - 0.5), ay - headLen * Math.sin(a - 0.5));
          ctx.lineTo(ax - headLen * Math.cos(a + 0.5), ay - headLen * Math.sin(a + 0.5));
          ctx.closePath();
          ctx.fillStyle = 'rgba(255,200,0,0.4)';
          ctx.fill();
        }
      }
    }

    function drawFrame() {
      drawBackground();
      drawMediumOverlay();
      drawPotentialGradient();
      drawFieldLines();
      drawEquipotentialCircles();
      drawDistanceLine();
      drawElectricFieldDirection();
      drawPotentialLabel();
      drawCharge(q1);
      drawTestPoint(q2);
      drawMediumLabel();
      updateDataPanel();
    }

    function draw() {
      drawFrame();
    }

    // === ANIMATION LOOP ===
    var animRunning = false;

    function animLoop() {
      if (!animRunning) return;
      glowPhase += 0.02;
      if (glowPhase > Math.PI * 2) glowPhase -= Math.PI * 2;

      // Achievement checks
      var rPx = getDistPx();
      if (rPx > canvasW * 0.7) {
        var absV = Math.abs(getRealPotential());
        if (absV < 50) {
          _achPotentialZero = true;
        }
      }
      if (q1.mag === 5 && rPx < CHARGE_RADIUS * 2 + 30) {
        _achHighPotential = true;
      }

      drawFrame();
      if (Math.round(glowPhase * 50) % 3 === 0) {
        recordPotentialPoint();
        drawPlot();
      }
      requestAnimationFrame(animLoop);
    }

    function startAnim() {
      if (!animRunning) {
        animRunning = true;
        requestAnimationFrame(animLoop);
      }
    }

    function stopAnim() {
      animRunning = false;
    }

    // === DRAG INTERACTION ===
    function getCanvasPos(e) {
      var rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      }
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function isOverQ2(mx, my) {
      return Math.hypot(mx - q2.x, my - q2.y) < GRAB_RADIUS;
    }

    canvas.addEventListener('mousedown', function(e) {
      var pos = getCanvasPos(e);
      if (isOverQ2(pos.x, pos.y)) {
        draggingQ2 = true;
        canvas.style.cursor = 'grabbing';
        e.preventDefault();
      }
    });

    canvas.addEventListener('mousemove', function(e) {
      var pos = getCanvasPos(e);
      if (draggingQ2) {
        q2.x = Math.max(PROBE_RADIUS, Math.min(canvasW - PROBE_RADIUS, pos.x));
        q2.y = Math.max(PROBE_RADIUS, Math.min(canvasH - PROBE_RADIUS, pos.y));
        // Prevent overlap with Q1
        var dx = q2.x - q1.x;
        var dy = q2.y - q1.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        var minDist = CHARGE_RADIUS + PROBE_RADIUS + 4;
        if (dist < minDist && dist > 0) {
          q2.x = q1.x + (dx / dist) * minDist;
          q2.y = q1.y + (dy / dist) * minDist;
        }
      } else {
        canvas.style.cursor = isOverQ2(pos.x, pos.y) ? 'grab' : 'default';
      }
    });

    canvas.addEventListener('mouseup', function() {
      if (draggingQ2) {
        draggingQ2 = false;
        canvas.style.cursor = 'default';
      }
    });

    canvas.addEventListener('mouseleave', function() {
      if (draggingQ2) {
        draggingQ2 = false;
        canvas.style.cursor = 'default';
      }
    });

    // Touch support
    canvas.addEventListener('touchstart', function(e) {
      var pos = getCanvasPos(e);
      if (isOverQ2(pos.x, pos.y)) {
        draggingQ2 = true;
        e.preventDefault();
      }
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
      if (draggingQ2) {
        e.preventDefault();
        var rect = canvas.getBoundingClientRect();
        var tx = e.touches[0].clientX - rect.left;
        var ty = e.touches[0].clientY - rect.top;
        q2.x = Math.max(PROBE_RADIUS, Math.min(canvasW - PROBE_RADIUS, tx));
        q2.y = Math.max(PROBE_RADIUS, Math.min(canvasH - PROBE_RADIUS, ty));
        var dx = q2.x - q1.x;
        var dy = q2.y - q1.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        var minDist = CHARGE_RADIUS + PROBE_RADIUS + 4;
        if (dist < minDist && dist > 0) {
          q2.x = q1.x + (dx / dist) * minDist;
          q2.y = q1.y + (dy / dist) * minDist;
        }
      }
    }, { passive: false });

    canvas.addEventListener('touchend', function() {
      if (draggingQ2) {
        draggingQ2 = false;
      }
    });

    canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });

    // === FIELD LINES TOGGLE ===
    document.getElementById('fieldLinesBtn').addEventListener('click', function() {
      showFieldLines = !showFieldLines;
      this.classList.toggle('active', showFieldLines);
    });

    // === FULLSCREEN ===
    document.getElementById('fullscreenBtn').addEventListener('click', function() {
      var el = document.getElementById('simArea');
      if (!document.fullscreenElement) {
        (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen).call(el);
      } else {
        (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document);
      }
    });

    document.addEventListener('fullscreenchange', function() {
      setTimeout(function() { resizeCanvas(); resizePlotCanvas(); }, 100);
      setTimeout(function() { resizeCanvas(); resizePlotCanvas(); }, 300);
    });

    // === TUTORIAL OVERLAY ===
    function drawCurvedArrow(svg, x1, y1, x2, y2) {
      var ns = 'http://www.w3.org/2000/svg';
      var dx = x2 - x1;
      var dy = y2 - y1;
      var cx1 = x1 + dx * 0.2;
      var cy1 = y1 + dy * 0.6;
      var cx2 = x1 + dx * 0.8;
      var cy2 = y1 + dy * 0.4;

      var path = document.createElementNS(ns, 'path');
      path.setAttribute('d',
        'M' + x1 + ',' + y1 +
        ' C' + cx1 + ',' + cy1 +
        ' ' + cx2 + ',' + cy2 +
        ' ' + x2 + ',' + y2
      );
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', 'rgba(255,255,255,0.85)');
      path.setAttribute('stroke-width', '2');
      path.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path);

      var angle = Math.atan2(y2 - cy2, x2 - cx2);
      var headLen = 10;
      var a1x = x2 - headLen * Math.cos(angle - 0.4);
      var a1y = y2 - headLen * Math.sin(angle - 0.4);
      var a2x = x2 - headLen * Math.cos(angle + 0.4);
      var a2y = y2 - headLen * Math.sin(angle + 0.4);
      var arrow = document.createElementNS(ns, 'polygon');
      arrow.setAttribute('points',
        x2 + ',' + y2 + ' ' +
        a1x + ',' + a1y + ' ' +
        a2x + ',' + a2y
      );
      arrow.setAttribute('fill', 'rgba(255,255,255,0.85)');
      svg.appendChild(arrow);
    }

    function positionTutorialHints() {
      var area = document.getElementById('simArea');
      var areaRect = area.getBoundingClientRect();
      var svg = document.getElementById('tutArrowsSvg');
      svg.innerHTML = '';

      var targets = [
        { hint: 'tutHintCharges', el: document.getElementById('q1Ctrl'), type: 'bottom' },
        { hint: 'tutHintDrag',    el: document.getElementById('simCanvas'), type: 'canvas' },
        { hint: 'tutHintMedium',  el: document.getElementById('mediumSelect'), type: 'bottom' }
      ];

      var placed = [];

      for (var i = 0; i < targets.length; i++) {
        var t = targets[i];
        var hintEl = document.getElementById(t.hint);
        if (!t.el) continue;
        var elRect = t.el.getBoundingClientRect();
        var cx = elRect.left + elRect.width / 2 - areaRect.left;
        var cy = elRect.top - areaRect.top;

        if (t.type === 'canvas') {
          var midX = elRect.left + elRect.width / 2 - areaRect.left;
          var midY = elRect.top + elRect.height * 0.35 - areaRect.top;
          hintEl.style.left = midX + 'px';
          hintEl.style.top = midY + 'px';
          hintEl.style.transform = 'translateX(-50%)';
          hintEl.style.right = '';
          continue;
        }

        hintEl.style.left = cx + 'px';
        hintEl.style.transform = 'translateX(-50%)';
        hintEl.style.top = '0px';

        var hintRect = hintEl.getBoundingClientRect();
        var hintW = hintRect.width;
        var hintH = hintRect.height;

        var desiredTop = cy - 50;
        var hintLeft = cx - hintW / 2;
        var hintRight = hintLeft + hintW;

        var finalTop = desiredTop;
        for (var j = 0; j < placed.length; j++) {
          var p = placed[j];
          if (hintRight > p.left && hintLeft < p.right) {
            if (finalTop + hintH > p.top && finalTop < p.bottom) {
              finalTop = p.top - hintH - 8;
            }
          }
        }

        hintEl.style.top = finalTop + 'px';
        placed.push({
          left: hintLeft,
          right: hintRight,
          top: finalTop,
          bottom: finalTop + hintH
        });

        var arrowStartX = cx;
        var arrowStartY = finalTop + hintH + 2;
        var arrowEndX = cx;
        var arrowEndY = cy + 2;
        drawCurvedArrow(svg, arrowStartX, arrowStartY, arrowEndX, arrowEndY);
      }
    }

    function showTutorial() {
      var el = document.getElementById('simTutorial');
      el.style.display = '';
      el.offsetHeight;
      el.style.opacity = '1';
      positionTutorialHints();
    }

    window.addEventListener('resize', function() {
      if (document.getElementById('simTutorial').style.display !== 'none') {
        positionTutorialHints();
      }
    });

    function dismissTutorial() {
      var el = document.getElementById('simTutorial');
      el.style.opacity = '0';
      setTimeout(function() { el.style.display = 'none'; }, 400);
      localStorage.setItem('tut-electrostatic-potential', '1');
    }

    if (!localStorage.getItem('tut-electrostatic-potential')) {
      showTutorial();
    }

    document.getElementById('simTutorial').addEventListener('click', dismissTutorial);
    document.getElementById('helpBtn').addEventListener('click', showTutorial);

    // === INIT ===
    resizeCanvas();
    resizePlotCanvas();
    buildChargeControls();
    startAnim();
  </script>
  <script src="../js/main.js"></script>
  <script src="../js/auth-gate.js"></script>
<script>if("serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js");}</script>
</body>
</html>
